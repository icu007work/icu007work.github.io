<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>Kotlin安卓开发-使用网络技术 | 米奇妙妙屋</title><meta name="keywords" content="Kotlin,编程入门"><meta name="author" content="Rookie_l"><meta name="copyright" content="Rookie_l"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#18171d"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="Kotlin安卓开发-使用网络技术"><meta name="application-name" content="Kotlin安卓开发-使用网络技术"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#18171d"><meta property="og:type" content="article"><meta property="og:title" content="Kotlin安卓开发-使用网络技术"><meta property="og:url" content="https://icu007work.github.io/archives/4a483fcb.html"><meta property="og:site_name" content="米奇妙妙屋"><meta property="og:description" content="如果你在玩手机的时候不能上网，那你一定会感到特别地枯燥乏味。没错，现在早已不是玩单机的时代了，无论是PC、手机、平板，还是电视，都具备上网的功能， 21世纪的确是互联网的时代。 当然，Android手机肯定也是可以上网的。作为开发者，我们就需要考虑如何利用网络编写出更加出色的应用程序，像QQ、微博、"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://pic2.ziyuan.wang/user/xiheya/2024/05/Network_0d14f49c4bca7.jpg"><meta property="article:author" content="Rookie_l"><meta property="article:tag" content="二次元 码农 地中海"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic2.ziyuan.wang/user/xiheya/2024/05/Network_0d14f49c4bca7.jpg"><meta name="description" content="如果你在玩手机的时候不能上网，那你一定会感到特别地枯燥乏味。没错，现在早已不是玩单机的时代了，无论是PC、手机、平板，还是电视，都具备上网的功能， 21世纪的确是互联网的时代。 当然，Android手机肯定也是可以上网的。作为开发者，我们就需要考虑如何利用网络编写出更加出色的应用程序，像QQ、微博、"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://icu007work.github.io/archives/4a483fcb"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2023/09/03/125766904/ee23df8517f3c3e3efc4145658269c06_5714860933110284659.png"},
  postHeadAiDescription: {"enable":true,"gptName":"Rookie","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 你你你去哪啦??!","backTitle":"♪(^∇^*)你回来啦！"},
  LA51: {"enable":true,"ck":"3FfSkp1Eunbavgru","LingQueMonitorID":"3FfSkp1Eunbavgru"},
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: {"source":3},
  friends_vue_info: {"apiurl":"hexo-circle-of-friends-flax-ten.vercel.app/"},
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"本文最后更新于","messageNext":"天前，其中的信息可能已经有所发展或是发生改变，请谨慎参考。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":true,"limitCount":50,"languages":{"author":"作者: Rookie_l","link":"链接: ","source":"来源: 米奇妙妙屋","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: '米奇妙妙屋',
  title: 'Kotlin安卓开发-使用网络技术',
  postAI: '这篇文章主要介绍了在Android开发中如何使用网络技术，特别是如何使用HTTP与服务器进行交互和解析服务器返回的数据。文章首先强调了网络技术在现代应用开发中的重要性，举例说明了许多常见的应用，如QQ、微博、微信等，都大量使用了网络技术。然后，文章介绍了WebView的用法。WebView是Android提供的一个控件，可以在应用程序中嵌入一个浏览器，从而轻松地展示各种网页。这对于一些特殊的需求，比如在应程序中展示网页，但又不允许打开系统浏览器的情况，非常有用。最后，文章提供了一个创建WebView项目的示例，展示了如何在activity_main.xml中添加WebView控件的代码。',
  pageFillDescription: '一、WebView的用法, 二、使用HTTP访问网络, 2.1 使用HttpURLConnection, 2.2 使用OkHttp, 三、解析XML格式数据, 3.0 准备工作(使用Apache服务器), 3.1 Pull解析方式, 3.2 SAX解析方式, 四、解析JSON格式数据, 4.1 使用JSONObject, 4.2 使用GSON, 五、网络请求回调的实现方式, 六、最好用的网络库： Retrofit, 6.1 Retrofit的基本用法, 6.2 处理复杂的接口地址类型, 6.3 Retrofit构建器的最佳写法如果你在玩手机的时候不能上网那你一定会感到特别地枯燥乏味没错现在早已不是玩单机的时代了无论是手机平板还是电视都具备上网的功能世纪的确是互联网的时代当然手机肯定也是可以上网的作为开发者我们就需要考虑如何利用网络编写出更加出色的应用程序像微博微信等常见的应用都会大量使用网络技术本章主要讲述如何在手机端使用和服务器进行网络交互并对服务器返回的数据进行解析这也是中最常使用到的网络技术下面就让我们一起来学习一下吧一的用法有时候我们可能会碰到一些比较特殊的需求比如说在应用程序里展示一些网页相信每个人都知道加载和显示网页通常是浏览器的任务但是需求里又明确指出不允许打开系统浏览器我们当然不可能自己去编写一个浏览器出来这时应该怎么办呢不用担心早就考虑到了这种需求并提供了一个控件借助它我们就可以在自己的应用程序里嵌入一个浏览器从而非常轻松地展示各种各样的网页的用法也相当简单新建一个项目然后修改中的代码如下所示我们在布局文件中使用到了一个新的控件这个控件就是用来显示网页的这里的写法很简单给它设置了一个并让它充满整个屏幕然后修改中的代码如下所示中的代码也很短通过的方法可以设置一些浏览器的属性这里我们并没有设置过多的属性只是调用了方法让支持脚本接下来是比较重要的一个部分我们调用了的方法并传入了一个的实例这段代码的作用是当需要从一个网页跳转到另一个网页时我们希望目标网页仍然在当前中显示而不是打开系统浏览器最后一步就非常简单了调用的方法并将网址传入即可展示相应网页的内容另外还需要注意由于本程序使用到了网络功能而访问网络是需要声明权限的因此我们还得修改文件并加入权限声明如下所示可以看到这个程序现在已经具备了一个简易浏览器的功能不仅成功将博客的首页展示了出来还可以通过点击链接浏览更多的网页二使用访问网络对于这里只需要稍微了解一些就足够了它的工作原理特别简单就是客户端向服务器发出一条请求服务器收到请求之后会返回一些数据给客户端然后客户端再对这些数据进行解析和处理就可以了是不是非常简单一个浏览器的基本工作原理也就是如此了比如说上一节中使用到的控件其实就是我们向博客的服务器发起了一条请求接着服务器分析出我们想要访问的是百度的首页于是把该网页的代码进行返回然后再调用手机浏览器的内核对返回的代码进行解析最终将页面展示出来简单来说已经在后台帮我们处理好了发送请求接收服务器响应解析返回数据以及最终的页面展示这几步工作只不过它封装得实在是太好了反而使得我们不能那么直观地看出到底是如何工作的因此接下来就让我们通过手动发送请求的方式更加深入地理解这个过程使用在过去上发送请求一般有两种方式和不过由于存在数量过多扩展困难等缺点团队越来越不建议我们使用这种方式终于在系统中的功能被完全移除了标志着此功能被正式弃用因此本小节我们就学习一下现在官方建议使用的的用法首先需要获取的实例一般只需创建一个对象并传入目标的网络地址然后调用一下方法即可如下所示在得到了的实例之后我们可以设置一下请求所使用的方法常用的方法主要有两个和表示希望从服务器那里获取数据而则表示希望提交数据给服务器写法如下接下来就可以进行一些自由的定制了比如设置连接超时读取超时的毫秒数以及服务器希望得到的一些消息头等这部分内容根据自己的实际情况进行编写示例写法如下之后再调用方法就可以获取到服务器返回的输入流了剩下的任务就是对输入流进行读取最后可以调用方法将这个连接关闭下面通过一个具体的例子来真正体验一下的用法新建一个项目首先修改中的代码如下所示这里我们使用了一个新的控件它是用来做什么的呢由于手机屏幕的空间一般比较小有些时候过多的内容一屏是显示不下的借助控件我们就可以以滚动的形式查看屏幕外的内容另外布局中还放置了一个和一个用于发送请求用于将服务器返回的数据显示出来接着修改中的代码开启线程发起网络请求下面对获取到的输入流进行读取在这里进行操作将结果显示到界面上可以看到我们在按钮的点击事件里调用了方法在这个方法中先是开启了一个子线程然后在子线程里使用发出一条请求请求的目标地址就是百度的首页接着利用对服务器返回的流进行读取并将结果传入方法中而在方法里则是调用了一个方法然后在这个方法的表达式中进行操作将返回的数据显示到界面上那么这里为什么要用这个方法呢别忘了是不允许在子线程中进行操作的我们之前学习了异步消息处理机制的工作原理而方法其实就是对异步消息处理机制进行了一层封装它背后的工作原理和之前介绍的内容是一模一样的借助这个方法我们就可以将服务器返回的数据更新到界面上了完整的流程就是这样不过在开始运行之前仍然别忘了要声明一下网络权限修改中的代码如下所示运行结果如下会将这些代码解析成漂亮的网页后再展示出来那么如果想要提交数据给服务器应该怎么办呢其实也不复杂只需要将请求的方法改成并在获取输入流之前把要提交的数据写出即可注意每条数据都要以键值对的形式存在数据与数据之间用符号隔开比如说我们想要向服务器提交用户名和密码就可以这样写使用当然我们并不是只能使用完全没有任何其他选择事实上在开源盛行的今天有许多出色的网络通信库都可以替代原生的而其中无疑是做得最出色的一个是由鼎鼎大名的公司开发的这个公司在开源事业上贡献良多除了之外还开发了等知名的开源项目不仅在接口封装上做得简单易用就连在底层实现上也是自成一派比起原生的可以说是有过之而无不及现在已经成了广大开发者首选的网络通信库那么本小节我们就来学习一下的用法的项目主页地址是在使用之前我们需要先在项目中添加库的依赖编辑文件在闭包中添加如下内容添加上述依赖会自动下载两个库一个是库一个是库下面我们来看一下的具体用法首先需要创建一个的实例如下所示接下来如果想要发起一条请求就需要创建一个对象当然上述代码只是创建了一个空的对象并没有什么实际作用我们可以在最终的方法之前连缀很多其他方法来丰富这个对象比如可以通过方法来设置目标的网络地址如下所示之后调用的方法来创建一个对象并调用它的方法来发送请求并获取服务器返回的数据写法如下对象就是服务器返回的数据了我们可以使用如下写法来得到返回的具体内容如果是发起一条请求会比请求稍微复杂一点我们需要先构建一个对象来存放待提交的参数如下所示然后在中调用一下方法并将对象传入接下来的操作就和请求一样了调用方法来发送请求并获取服务器返回的数据即可好了的基本用法就先学到这里在本章的稍后部分我们还会学习结合的使用方法到时候再进一步学习那么现在我们先把这个项目改用的方式再实现一遍吧代码如下开启线程发起网络请求下面对获取到的输入流进行读取在这里进行操作将结果显示到界面上三解析格式数据通常情况下每个需要访问网络的应用程序都会有一个自己的服务器我们可以向服务器提交数据也可以从服务器上获取数据不过这个时候就出现了一个问题这些数据到底要以什么样的格式在网络上传输呢随便传递一段文本肯定是不行的因为另一方根本就不知道这段文本的用途是什么因此一般我们会在网络上传输一些格式化后的数据这种数据会有一定的结构规则和语义当另一方收到数据消息之后就可以按照相同的结构规则进行解析从而取出想要的那部分内容在网络上传输数据时最常用的格式有两种和下面我们就来一个一个地进行学习本节首先学习一下如何解析格式的数据准备工作使用服务器在开始之前我们还需要先解决一个问题就是从哪儿才能获取一段格式的数据呢这里我准备教你搭建一个最简单的服务器在这个服务器上提供一段文本然后我们在程序里去访问这个服务器再对得到的文本进行解析搭建服务器的过程其实非常简单也有很多种服务器类型可供选择我们准备使用服务器另外这里只会演示系统下的搭建过程因为和系统都是默认安装好服务器的只需要启动一下即可如果你使用的是这两种系统可以自行搜索一下具体的操作方法下面来看系统下的搭建过程首先你需要下载一个服务器的安装包官方下载地址是官网但是在官网下载时我们会发现本身已经不提供已编译的安装包了只提供源码但是他为我们推荐了第三方提供编译的网站下载后解压打开所在目录中的文件有几个地方需要修改需要改成自己所在目录监听端口按需修改改为监听的端口号而后用命令在目录下执行出现如下字样且在浏览器打开设置的出现字样即安装成功后续可以输入指令启动启动停止接下来在目录下在这里新建一个名为的文件然后编辑这个文件并加入如下格式的内容这时在浏览器中访问这个网址应出现如下所示内容解析方式解析格式的数据其实也有挺多种方式的本节中我们学习比较常用的两种解析和解析那么简单起见这里仍然是在项目的基础上继续开发这样我们就可以重用之前网络通信部分的代码从而把工作的重心放在数据解析上既然格式的数据已经提供好了现在要做的就是从中解析出我们想要得到的那部分内容修改中的代码如下所示开启线程发起网络请求下面对获取到的输入流进行读取在这里进行操作将结果显示到界面上开始解析某个节点完成解析某个节点可以看到这里首先将请求的地址改成了对于模拟器来说就是计算机本机的地址在得到了服务器返回的数据后我们不再直接将其展示而是调用了方法来解析服务器返回的数据下面就来仔细看下方法中的代码吧这里首先要创建一个的实例并借助这个实例得到对象然后调用的方法将服务器返回的数据设置进去之后就可以开始解析了解析的过程也非常简单通过可以得到当前的解析事件然后在一个循环中不断地进行解析如果当前的解析事件不等于说明解析工作还没完成调用方法后可以获取下一个解析事件在循环中我们通过方法得到了当前节点的名字如果发现节点名等于或就调用方法来获取节点内具体的内容每当解析完一个节点就将获取到的内容打印出来好了整体的过程就是这么简单不过在程序运行之前还得再进行一项额外的配置从系统开始应用程序默认只允许使用类型的网络请求类型的网络请求因为有安全隐患默认不再被支持而我们搭建的服务器现在使用的就是那么为了能让程序使用我们还要进行如下配置才可以右击目录创建一个目录接着右击目录创建一个文件然后修改文件中的内容如下所示这段配置文件的意思就是允许我们以明文的方式在网络上传输数据而使用的就是明文传输方式接下来修改中的代码来启用我们刚才创建的配置文件运行项目然后点击按钮观察中的打印日志可以看到数据中的指定内容已经解析出来了解析方式解析方式虽然非常好用但它并不是我们唯一的选择解析也是一种特别常用的解析方式虽然它的用法比解析要复杂一些但在语义方面会更加清楚要使用解析通常情况下我们会新建一个类继承自并重写父类的个方法如下所示方法会在开始解析的时候调用方法会在开始解析某个节点的时候调用方法会在获取节点中内容的时候调用方法会在完成解析某个节点的时候调用方法会在完成整个解析的时候调用其中和这个方法是有参数的从中解析出的数据就会以参数的形式传入这些方法中需要注意的是在获取节点中的内容时方法可能会被调用多次一些换行符也被当作内容解析出来我们需要针对这种情况在代码中做好控制那么下面就让我们尝试用解析的方式来实现和上一小节同样的功能吧新建一个类继承自并重写父类的个方法最后将清空可以看到我们首先给和节点分别定义了一个对象并在方法里对它们进行了初始化每当开始解析某个节点的时候方法就会得到调用其中参数记录着当前节点的名字这里我们把它记录下来接着在解析节点中具体内容的时候就会调用方法我们会根据当前的节点名进行判断将解析出的内容添加到哪一个对象中最后在方法中进行判断如果节点已经解析完成就打印出和的内容需要注意的是目前和中都可能是包括回车或换行符的因此在打印之前我们还需要调用一下方法并且打印完成后要将的内容清空不然的话会影响下一次内容的读取接下来的工作就非常简单了修改中的代码如下所示在得到了服务器返回的数据后我们这次通过调用方法来解析数据方法中先是创建了一个的对象然后再获取对象接着将我们编写的的实例设置到中最后调用方法开始执行解析观察会发现结果和解析是一致的四解析格式数据现在你已经掌握了格式数据的解析方式那么接下来我们要学习一下如何解析格式的数据了比起的主要优势在于它的体积更小在网络上传输的时候更省流量但缺点在于它的语义性较差看起来不如直观在开始之前我们还需要在目录中新建一个的文件然后编辑这个文件并加入如下格式的内容使用解析数据也有很多种方法可以使用官方提供的也可以使用的开源库另外一些第三方的开源库如等也非常不错本节中我们就来学习一下前两种解析方式的用法修改中的代码如下首先将请求的地址改成然后在得到服务器返回的数据后调用方法来解析数据可以看到解析的代码真的非常简单由于我们在服务器中定义的是一个数组因此这里首先将服务器返回的数据传入一个对象中然后循环遍历这个从中取出的每一个元素都是一个对象每个对象中又会包含和这些数据接下来只需要调用方法将这些数据取出并打印出来即可运行结果如下使用使用来解析数据已经非常简单了但是提供的开源库可以让解析数据的工作简单到让你不敢想象的地步仓库不过并没有被添加到官方的中因此如果想要使用这个功能的话就必须在项目中添加库的依赖编辑文件在闭包中添加如下内容那么库究竟是神奇在哪里呢它的强大之处就在于可以将一段格式的字符串自动映射成一个对象从而不需要我们再手动编写代码进行解析了比如说一段格式的数据如下所示那我们就可以定义一个类并加入和这两个字段然后只需简单地调用如下代码就可以将数据自动解析成一个对象了如果需要解析的是一段数组会稍微麻烦一点比如如下格式的数据这个时候我们需要借助将期望解析成的数据类型传入方法中如下所示好了基本的用法就是这样下面就让我们来真正地尝试一下首先新增一个类并加入和这个字段如下所示然后修改中的代码如下观察打印日志与使用结果一致五网络请求回调的实现方式目前我们已经掌握了和的用法知道了如何发起请求以及解析服务器返回的数据但之前我们的写法其实是很有问题的因为一个应用程序很可能会在许多地方都使用到网络功能而发送请求的代码基本是相同的如果我们每次都去编写一遍发送请求的代码这显然是非常差劲的做法没错通常情况下我们应该将这些通用的网络操作提取到一个公共的类里并提供一个通用方法当想要发起网络请求的时候只需简单地调用一下这个方法即可比如使用如下的写法以后每当需要发起一条请求的时候就可以这样写在获取到服务器响应的数据后我们就可以对它进行解析和处理了但是需要注意网络请求通常属于耗时操作而方法的内部并没有开启线程这样就有可能导致在调用方法的时候主线程被阻塞那在方法内部开启一个线程不就解决这个问题了吗其实没有想象中那么容易因为如果我们在方法中开启一个线程来发起请求服务器响应的数据是无法进行返回的这是由于所有的耗时逻辑都是在子线程里进行的方法会在服务器还没来得及响应的时候就执行结束了当然也就无法返回响应的数据了那么在遇到这种情况时应该怎么办呢其实解决方法并不难只需要使用编程语言的回调机制就可以了下面就来学习一下回调机制到底是如何使用的首先需要定义一个接口比如将它命名成代码如下所示可以看到我们在接口中定义了两个方法方法表示当服务器成功响应我们请求的时候调用表示当进行网络操作出现错误的时候调用这两个方法都带有参数方法中的参数代表服务器返回的数据而方法中的参数记录着错误的详细信息接着修改中的代码我们首先给方法添加了一个参数并在方法的内部开启了一个子线程然后在子线程里执行具体的网络操作注意子线程中是无法通过语句返回数据的因此这里我们将服务器响应的数据传入了的方法中如果出现了异常就将异常原因传入方法中现在方法接收两个参数因此我们在调用它的时候还需要将的实例传入如下所示对异常情况进行处理得到服务器返回的具体内容这样当服务器成功响应的时候我们就可以在方法里对响应数据进行处理了类似地如果出现了异常就可以在方法里对异常情况进行处理如此一来我们就巧妙地利用回调机制将响应数据成功返回给调用方了不过你会发现上述使用的写法总体来说还是比较复杂的那么使用会变得简单吗答案是肯定的而且要简单得多下面我们来具体看一下在中加入一个方法如下所示可以看到方法中有一个参数这个是库中自带的回调接口类似于我们刚才自己编写的然后在之后没有像之前那样一直调用方法而是调用了一个方法并把参数传入在方法的内部已经帮我们开好子线程了然后会在子线程中执行请求并将最终的请求结果回调到当中那么我们在调用方法的时候就可以这样写得到服务器返回的具体内容进行异常情况处理由此可以看出的接口设计得确实非常人性化它将一些常用的功能进行了很好的封装使得我们只需编写少量的代码就能完成较为复杂的网络操作另外需要注意的是不管是使用还是最终的回调接口都还是在子线程中运行的因此我们不可以在这里执行任何的操作除非借助方法来进行类型转换六最好用的网络库既然学习网络技术那么就不得不提到因为它实在是太好用了同样是一款由公司开发的网络库但是它和的定位完全不同侧重的是底层通信的实现而侧重的是上层接口的封装事实上就是公司在的基础上进一步开发出来的应用层网络通信库使得我们可以用更加面向对象的思维进行网络操作的项目主页地址是仓库的基本用法的设计基于以下几个事实同一款应用程序中所发起的网络请求绝大多数指向的是同一个服务器域名这个很好理解因为任何公司的产品客户端和服务器都是配套的很难想象一个客户端一会去这个服务器获取数据一会又要去另外一个服务器获取数据吧另外服务器提供的接口通常是可以根据功能来归类的比如新增用户修改用户数据查询用户数据这几个接口就可以归为一类上架新书销售图书查询可供销售图书这几个接口也可以归为一类将服务器接口合理归类能够让代码结构变得更加合理从而提高可阅读性和可维护性最后开发者肯定更加习惯于调用一个接口获取它的返回值这样的编码方式但当调用的是服务器接口时却很难想象该如何使用这样的编码方式其实大多数人并不关心网络的具体通信细节但是传统网络库的用法却需要编写太多网络相关的代码而的用法就是基于以上几点来设计的首先我们可以配置好一个根路径然后在指定服务器接口地址时只需要使用相对路径即可这样就不用每次都指定完整的地址了另外允许我们对服务器接口进行归类将功能同属一类的服务器接口定义到同一个接口文件当中从而让代码结构变得更加合理最后我们也完全不用关心网络通信的细节只需要在接口文件中声明一系列方法和返回值然后通过注解的方式指定该方法对应哪个服务器接口以及需要提供哪些参数当我们在程序中调用该方法时会自动向对应的服务器接口发起请求并将响应的数据解析成返回值声明的类型这就使得我们可以用更加面向对象的思维来进行网络操作的基本设计思想差不多就是这些下面就通过一个具体的例子来快速体验一下的用法要想使用我们需要先在项目中添加必要的依赖库编辑文件在闭包中添加如下内容由于是基于开发的因此添加上述第一条依赖会自动将和这几个库一起下载我们无须再手动引入库另外还会将服务器返回的数据自动解析成对象因此上述第二条依赖就是一个的转换库它是借助来解析数据的所以会自动将库一起下载下来这样我们也不用手动引入库了除了之外还支持各种其他主流的解析库包括等不过毫无疑问是最常用的我们使用之前提供的数据接口由于会借助将数据转换成对象因此这里同样需要新增一个类并加入和这个字段如下所示接下来我们可以根据服务器接口的功能进行归类创建不同种类的接口文件并在其中定义对应具体服务器接口的方法不过由于我们的服务器上其实只有一个获取数据的接口因此这里只需要定义一个接口文件并包含一个方法即可新建接口代码如下所示通常的接口文件建议以具体的功能种类名开头并以结尾这是一种比较好的命名习惯上述代码中有两点需要我们注意第一就是在方法上面添加的注解这里使用了一个注解表示当调用方法时会发起一条请求请求的地址就是我们在注解中传入的具体参数注意这里只需要传入请求地址的相对路径即可根路径我们会在稍后设置第二就是方法的返回值必须声明成中内置的类型并通过泛型来指定服务器响应的数据应该转换成什么对象由于服务器响应的是一个包含数据的数组因此这里我们将泛型声明成当然还提供了强大的功能来允许我们自定义方法返回值的类型比如结合使用就可以将返回值声明成等类型定义好了接口之后接下来的问题就是该如何使用它为了方便测试我们还得在界面上添加一个按钮才行修改中的代码如下所示修改中的代码如下所示在按钮的点击事件当中首先使用了来构建一个对象其中方法用于指定所有请求的根路径方法用于指定在解析数据时所使用的转换库这里指定成注意这两个方法都是必须调用的有了对象之后我们就可以调用它的方法并传入具体接口所对应的类型创建一个该接口的动态代理对象如果不熟悉什么是动态代理也没有关系只需要知道有了动态代理对象之后我们就可以随意调用接口中定义的所有方法而会自动执行具体的处理就可以了对应到上述的代码当中当调用了的方法时会返回一个对象这时我们再调用一下它的方法就会根据注解中配置的服务器接口地址去进行网络请求了服务器响应的数据会回调到方法中传入的实现里面需要注意的是当发起请求的时候会自动在内部开启子线程当数据回调到中之后又会自动切换回主线程整个操作过程中我们都不用考虑线程切换问题在的方法中调用方法将会得到解析后的对象也就是类型的数据最后遍历将其中的数据打印出来即可这里使用的服务器接口仍然是因此我们还要进行网络安全配置才行新建修改如下处理复杂的接口地址类型在上一小节中我们通过示例程序向一个非常简单的服务器接口地址发送请求然而在真实的开发环境当中服务器所提供的接口地址不可能一直如此简单如果你在使用浏览器上网时观察一下浏览器上的网址你会发现这些网址可能会是千变万化的那么本小节我们就来学习一下如何使用来应对这些千变万化的情况为了方便举例这里先定义一个类并包含和这两个字段如下所示然后我们先从最简单的看起比如服务器的接口地址如下所示这是最简单的一种情况接口地址是静态的永远不会改变那么对应到当中使用如下的写法即可这也是我们在上一小节中已经学过的部分理解起来应该非常简单吧但是显然服务器不可能总是给我们提供静态类型的接口在很多场景下接口地址中的部分内容可能会是动态变化的比如如下的接口地址在这个接口当中部分代表页数我们传入不同的页数服务器返回的数据也会不同这种接口地址对应到当中应该怎么写呢其实也很简单如下所示在注解指定的接口地址当中这里使用了一个的占位符然后又在方法中添加了一个参数并使用注解来声明这个参数这样当调用方法发起请求时就会自动将参数的值替换到占位符的位置从而组成一个合法的请求地址另外很多服务器接口还会要求我们传入一系列的参数格式如下这是一种标准的带参数请求的格式接口地址的最后使用问号来连接参数部分每个参数都是一个使用等号连接的键值对多个参数之间使用符号进行分隔那么很显然在上述地址中服务器要求我们传入和这两个参数的值对于这种格式的服务器接口我们可以使用刚才所学的注解的方式来解决但是这样会有些麻烦针对这种带参数的请求专门提供了一种语法支持这里在方法中添加了和这两个参数并使用注解对它们进行声明这样当发起网络请求的时候就会自动按照带参数请求的格式将这两个参数构建到请求地址当中学习了以上内容之后现在你在一定程度上已经可以应对千变万化的服务器接口地址了不过并不是只有请求这一种类型而是有很多种其中比较常用的有这几种它们之间的分工也很明确简单概括的话请求用于从服务器获取数据请求用于向服务器提交数据和请求用于修改服务器上的数据请求用于删除服务器上的数据而对所有常用的请求类型都进行了支持使用注解就可以让发出相应类型的请求了比如服务器提供了如下接口地址这种接口通常意味着要根据删除一条指定的数据而我们在当中想要发出这种请求就可以这样写这里使用了注解来发出类型的请求并使用了注解来动态指定这些都很好理解但是在返回值声明的时候我们将的泛型指定成了这是什么意思呢由于这几种请求类型与请求不同它们更多是用于操作服务器上的数据而不是获取服务器上的数据所以通常它们对于服务器响应的数据并不关心这个时候就可以使用表示能够接收任意类型的响应数据并且不会对响应数据进行解析那么如果我们需要向服务器提交数据该怎么写呢比如如下的接口地址使用请求来提交数据需要将数据放到请求的部分这个功能在中可以借助注解来完成可以看到这里我们在方法中声明了一个类型的参数并给它加上了注解这样当发出请求时就会自动将对象中的数据转换成格式的文本并放到请求的部分服务器在收到请求之后只需要从中将这部分数据解析出来即可这种写法同样也可以用来给类型的请求提交数据最后有些服务器接口还可能会要求我们在请求的中指定参数比如这些参数其实就是一个个的键值对我们可以在中直接使用注解来对它们进行声明但是这种写法只能进行静态声明如果想要动态指定的值则需要使用注解如下所示现在当发起网络请求的时候就会自动将参数中传入的值设置到和这两个当中从而实现了动态指定值的功能构建器的最佳写法学到这里其实还有一个问题我们没有正视过就是获取接口的动态代理对象实在是太麻烦了先回顾一下之前的写法吧大致代码如下所示我们想要得到的动态代理对象需要先使用构建出一个对象然后再调用对象的方法创建动态代理对象如果只是写一次还好每次调用任何服务器接口时都要这样写一遍的话肯定没有人能受得了事实上确实也没有每次都写一遍的必要因为构建出的对象是全局通用的只需要在调用方法时针对不同的接口传入相应的类型即可因此我们可以将通用的这部分功能封装起来从而简化获取接口动态代理对象的过程新建一个单例类代码如下所示这里我们使用关键字让成为了一个单例类并在它的内部定义了一个常量用于指定的根路径然后同样是在内部使用构建一个对象注意这些都是用修饰符来声明的相当于对于外部而言它们都是不可见的最后我们提供了一个外部可见的方法并接收一个类型的参数当在外部调用这个方法时实际上就是调用了对象的方法从而创建出相应接口的动态代理对象经过这样的封装之后的用法将会变得异常简单比如我们想获取一个接口的动态代理对象只需要使用如下写法即可之后就可以随意调用接口中定义的任何方法了上述代码通过之前学习的学习的泛型实化功能还可以继续优化修改中的代码如下所示可以看到我们又定义了一个不带参数的方法并使用关键字来修饰方法使用关键字来修饰泛型这是泛型实化的两大前提条件接下来就可以使用这种语法了这里调用刚才定义的带有参数的方法即可那么现在我们就又有了一种新的方式来获取接口的动态代理对象如下所示',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-11 15:46:06',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/mycss/charlie.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="米奇妙妙屋" type="application/atom+xml">
</head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://icu007.work/wp-content/uploads/2022/03/head-1.jpeg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://icu007.work/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.icu007.work/" title="ChatGPT"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="ChatGPT"/><span class="back-menu-item-text">ChatGPT</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://baidu.icu007.work/" title="帮你百度一下"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="帮你百度一下"/><span class="back-menu-item-text">帮你百度一下</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">米奇妙妙屋</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 站务</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=6842714056&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 番剧</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 碎碎念</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 传送门</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.jpg"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.jpg"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Android/" style="font-size: 1.05rem;">Android<sup>2</sup></a><a href="/tags/Dos/" style="font-size: 1.05rem;">Dos<sup>1</sup></a><a href="/tags/IDEA/" style="font-size: 1.05rem;">IDEA<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>23</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" style="font-size: 1.05rem;">Java基础语法<sup>5</sup></a><a href="/tags/Java%E5%BC%82%E5%B8%B8/" style="font-size: 1.05rem;">Java异常<sup>2</sup></a><a href="/tags/Java%E6%95%B0%E7%BB%84/" style="font-size: 1.05rem;">Java数组<sup>3</sup></a><a href="/tags/Java%E6%96%B9%E6%B3%95/" style="font-size: 1.05rem;">Java方法<sup>1</sup></a><a href="/tags/Java%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/" style="font-size: 1.05rem;">Java流程控制<sup>3</sup></a><a href="/tags/Java%E7%89%B9%E6%80%A7/" style="font-size: 1.05rem;">Java特性<sup>1</sup></a><a href="/tags/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">Java面向对象<sup>4</sup></a><a href="/tags/Kotlin/" style="font-size: 1.05rem;">Kotlin<sup>13</sup></a><a href="/tags/Markdown/" style="font-size: 1.05rem;">Markdown<sup>1</sup></a><a href="/tags/WP/" style="font-size: 1.05rem;">WP<sup>1</sup></a><a href="/tags/git/" style="font-size: 1.05rem;">git<sup>2</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">排序算法<sup>1</sup></a><a href="/tags/%E7%A1%AC%E4%BB%B6/" style="font-size: 1.05rem;">硬件<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/" style="font-size: 1.05rem;">编程入门<sup>13</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/" style="font-size: 1.05rem;">软件分享<sup>1</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 1.05rem;">随笔<sup>13</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/05/"><span class="card-archive-list-date">五月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Kotlin/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Kotlin</span></a><a class="article-meta__tags" href="/tags/%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>编程入门</span></a></span></div></div><h1 class="post-title" itemprop="name headline">Kotlin安卓开发-使用网络技术</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-03-13T07:37:24.000Z" title="发表于 2024-03-13 15:37:24">2024-03-13</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-05-11T07:46:06.282Z" title="更新于 2024-05-11 15:46:06">2024-05-11</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">15.4k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>60分钟</span></span><span class="post-meta-separator"></span><span class="post-meta-pv-cv" id="" data-flag-title="Kotlin安卓开发-使用网络技术"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="busuanzi_value_page_pv"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为深圳"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>深圳</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Network_0d14f49c4bca7.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><i class="anzhiyufont anzhiyu-icon-circle-dot" title="朗读摘要"></i><div id="ai-tag">Rookie GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己 🙈</div><div class="ai-btn-item">生成本文简介 👋</div><div class="ai-btn-item">推荐相关文章 📖</div><div class="ai-btn-item">前往主页 🏠</div><div class="ai-btn-item" id="go-tianli-blog">前往爱发电购买</div></div><script data-pjax src="/js/anzhiyu/ai_abstract.js"></script></div><article class="post-content" id="article-container" itemscope itemtype="https://icu007work.github.io/archives/4a483fcb.html"><header><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url">技术</a><a href="/tags/Kotlin/" tabindex="-1" itemprop="url">Kotlin</a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/" tabindex="-1" itemprop="url">编程入门</a><h1 id="CrawlerTitle" itemprop="name headline">Kotlin安卓开发-使用网络技术</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Rookie_l</span><time itemprop="dateCreated datePublished" datetime="2024-03-13T07:37:24.000Z" title="发表于 2024-03-13 15:37:24">2024-03-13</time><time itemprop="dateCreated datePublished" datetime="2024-05-11T07:46:06.282Z" title="更新于 2024-05-11 15:46:06">2024-05-11</time></header><p>如果你在玩手机的时候不能上网，那你一定会感到特别地枯燥乏味。没错，现在早已不是玩单机的时代了，无论是PC、手机、平板，还是电视，都具备上网的功能， 21世纪的确是互联网的时代。</p>
<p>当然，Android手机肯定也是可以上网的。作为开发者，我们就需要考虑如何利用网络编写出更加出色的应用程序，像QQ、微博、微信等常见的应用都会大量使用网络技术。本章主要讲述如何在手机端使用HTTP和服务器进行网络交互，并对服务器返回的数据进行解析，这也是Android中最常使用到的网络技术，下面就让我们一起来学习一下吧。</p>
<h2 id="一、WebView的用法"><a href="#一、WebView的用法" class="headerlink" title="一、WebView的用法"></a>一、WebView的用法</h2><p>有时候我们可能会碰到一些比较特殊的需求，比如说在应用程序里展示一些网页。相信每个人都知道，加载和显示网页通常是浏览器的任务，但是需求里又明确指出，不允许打开系统浏览器，我们当然不可能自己去编写一个浏览器出来，这时应该怎么办呢？不用担心，<strong>Android</strong>早就考虑到了这种需求，并提供了一个<strong>WebView</strong>控件，借助它我们就可以在自己的应用程序里嵌入一个浏览器，从而非常轻松地展示各种各样的网页。<strong>WebView</strong>的用法也相当简单。新建一个<strong>WebViewTest</strong>项目，然后修改<code>activity_main.xml</code>中的代码，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WebView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/webView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们在布局文件中使用到了一个新的控件：<strong>WebView</strong>。这个控件就是用来显示网页的，这里的写法很简单，给它设置了一个id，并让它充满整个屏幕。然后修改<strong>MainActivity</strong>中的代码，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ubx.webviewtest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.webkit.WebViewClient</span><br><span class="line"><span class="keyword">import</span> androidx.viewbinding.ViewBinding</span><br><span class="line"><span class="keyword">import</span> com.ubx.webviewtest.databinding.ActivityMainBinding</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.webView.settings.javaScriptEnabled = <span class="literal">true</span></span><br><span class="line">        mainBinding.webView.webViewClient = WebViewClient()</span><br><span class="line">        mainBinding.webView.loadUrl(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MainActivity</code>中的代码也很短，通过<strong>WebView</strong>的<code>getSettings()</code>方法可以设置一些浏览器的属性，这里我们并没有设置过多的属性，只是调用了<code>setJavaScriptEnabled()</code>方法，让WebView支持JavaScript脚本。</p>
<p>接下来是比较重要的一个部分，我们调用了<strong>WebView</strong>的<code>setWebViewClient()</code>方法，并传入了一个<strong>WebViewClient</strong>的实例。这段代码的作用是，当需要从一个网页跳转到另一个网页时，我们希望目标网页仍然在当前WebView中显示，而不是打开系统浏览器。</p>
<p>最后一步就非常简单了，调用<strong>WebView</strong>的<code>loadUrl()</code>方法，并将网址传入，即可展示相应网页的内容.</p>
<p>另外还需要注意，由于本程序使用到了网络功能，而访问网络是需要声明权限的，因此我们还得修改<code>AndroidManifest.xml</code>文件，并加入权限声明，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708236612706_7c011c4f58fe4.png" alt="1708236612706.png"></p>
<p>可以看到，WebViewTest这个程序现在已经具备了一个简易浏览器的功能，不仅成功将博客的首页展示了出来，还可以通过点击链接浏览更多的网页。</p>
<hr>
<h2 id="二、使用HTTP访问网络"><a href="#二、使用HTTP访问网络" class="headerlink" title="二、使用HTTP访问网络"></a>二、使用HTTP访问网络</h2><p>对于<strong>HTTP</strong>，这里只需要稍微了解一些就足够了，它的工作原理特别简单，就是客户端向服务器发出一条<strong>HTTP</strong>请求，服务器收到请求之后会返回一些数据给客户端，然后客户端再对这些数据进行解析和处理就可以了。是不是非常简单？一个浏览器的基本工作原理也就是如此了。<strong>比如说上一节中使用到的WebView控件，其实就是我们向博客的服务器发起了一条HTTP请求，接着服务器分析出我们想要访问的是百度的首页，于是把该网页的HTML代码进行返回，然后WebView再调用手机浏览器的内核对返回的HTML代码进行解析，最终将页面展示出来。</strong></p>
<p>简单来说，<strong>WebView已经在后台帮我们处理好了发送HTTP请求、接收服务器响应、解析返回数据，以及最终的页面展示这几步工作，只不过它封装得实在是太好了，反而使得我们不能那么直观地看出HTTP到底是如何工作的。因此，接下来就让我们通过手动发送HTTP请求的方式更加深入地理解这个过程。</strong></p>
<h3 id="2-1-使用HttpURLConnection"><a href="#2-1-使用HttpURLConnection" class="headerlink" title="2.1 使用HttpURLConnection"></a>2.1 使用HttpURLConnection</h3><p>在过去，<strong>Android</strong>上发送<strong>HTTP</strong>请求一般有两种方式：<strong>HttpURLConnection</strong>和<strong>HttpClient</strong>。不过由于<strong>HttpClient</strong>存在API数量过多、扩展困难等缺点，<strong>Android</strong>团队越来越不建议我们使用这种方式。终于在<strong>Android 6.0</strong>系统中，<strong>HttpClient</strong>的功能被完全移除了，标志着此功能被正式弃用，因此本小节我们就学习一下现在官方建议使用的<strong>HttpURLConnection</strong>的用法。</p>
<p>首先需要获取<strong>HttpURLConnection</strong>的实例，一般只需创建一个<strong>URL</strong>对象，并传入目标的网络地址，然后调用一下<code>openConnection()</code>方法即可，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> url = URL(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> connection = url.openConnection() <span class="keyword">as</span> HttpURLConnection</span><br></pre></td></tr></table></figure>

<p>在得到了<strong>HttpURLConnection</strong>的实例之后，我们可以设置一下<strong>HTTP</strong>请求所使用的方法。常用的方法主要有两个：<strong>GET</strong>和<strong>POST</strong>。<strong>GET</strong>表示希望从服务器那里获取数据，而<strong>POST</strong>则表示希望提交数据给服务器。写法如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.requestMethod = <span class="string">&quot;GET&quot;</span></span><br></pre></td></tr></table></figure>

<p>接下来就可以进行一些自由的定制了，比如设置连接超时、读取超时的毫秒数，以及服务器希望得到的一些消息头等。这部分内容根据自己的实际情况进行编写，示例写法如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connection.connectTimeout = <span class="number">8000</span></span><br><span class="line">connection.readTimeout = <span class="number">8000</span></span><br></pre></td></tr></table></figure>

<p>之后再调用<code>getInputStream()</code>方法就可以获取到服务器返回的输入流了，剩下的任务就是对输入流进行读取：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> input = connection.inputStream</span><br></pre></td></tr></table></figure>

<p>最后可以调用<code>disconnect()</code>方法将这个<strong>HTTP</strong>连接关闭：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connection.disconnect()</span><br></pre></td></tr></table></figure>

<p>下面通过一个具体的例子来真正体验一下<strong>HttpURLConnection</strong>的用法。新建一个<strong>NetworkTest</strong>项目，首先修改activity_main.xml中的代码，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/sendRequestBtn&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;Send Request&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_margin</span>=<span class="string">&quot;10dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ScrollView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@+id/sendRequestBtn&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/responseText&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我们使用了一个新的控件：<strong>ScrollView</strong>。它是用来做什么的呢？由于手机屏幕的空间一般比较小，有些时候过多的内容一屏是显示不下的，借助<strong>ScrollView</strong>控件，我们就可以以滚动的形式查看屏幕外的内容。另外，布局中还放置了一个<strong>Button</strong>和一个<strong>TextView</strong>，<strong>Button</strong>用于发送<strong>HTTP</strong>请求，<strong>TextView</strong>用于将服务器返回的数据显示出来。</p>
<p>接着修改 <strong>MainActivity</strong>中的代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line">            sendRequestWithHttpURLConnection()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithHttpURLConnection</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 开启线程发起网络请求</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">var</span> connection: HttpURLConnection? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> response = StringBuilder()</span><br><span class="line">                <span class="keyword">val</span> url = URL(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">                connection = url.openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connectTimeout = <span class="number">8000</span></span><br><span class="line">                connection.readTimeout = <span class="number">8000</span></span><br><span class="line">                <span class="keyword">val</span> input = connection.inputStream</span><br><span class="line">                <span class="comment">// 下面对获取到的输入流进行读取</span></span><br><span class="line">                <span class="keyword">val</span> reader = BufferedReader(InputStreamReader(input))</span><br><span class="line">                reader.use &#123;</span><br><span class="line">                    reader.forEachLine &#123;</span><br><span class="line">                        response.append(it)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                showResponse(response.toString())</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                connection?.disconnect()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showResponse</span><span class="params">(response: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        runOnUiThread &#123;</span><br><span class="line">            <span class="comment">// 在这里进行UI操作，将结果显示到界面上</span></span><br><span class="line">            mainBinding.responseText.text = response</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们在“Send Request”按钮的点击事件里调用了<code>sendRequestWithHttpURLConnection()</code>方法，在这个方法中先是开启了一个子线程，然后在子线程里使用<strong>HttpURLConnection</strong>发出一条HTTP请求，请求的目标地址就是百度的首页。接着利用<strong>BufferedReader</strong>对服务器返回的流进行读取，并将结果传入<code>showResponse()</code>方法中。而在<code>showResponse()</code>方法里，则是调用了一个<code>runOnUiThread()</code>方法，然后在这个方法的<strong>Lambda</strong>表达式中进行操作，将返回的数据显示到界面上。</p>
<p>那么这里为什么要用这个<code>runOnUiThread()</code>方法呢？别忘了，<strong>Android</strong>是不允许在子线程中进行UI操作的。我们之前学习了异步消息处理机制的工作原理，而<code>runOnUiThread()</code>方法其实就是对异步消息处理机制进行了一层封装，它背后的工作原理和之前介绍的内容是一模一样的。借助这个方法，我们就可以将服务器返回的数据更新到界面上了。</p>
<p>完整的流程就是这样。不过在开始运行之前，仍然别忘了要声明一下网络权限。修改<strong>AndroidManifest.xml</strong>中的代码，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708239819655_f046632467bd0.png" alt="1708239819655.png"></p>
<p>会将这些代码解析成漂亮的网页后再展示出来。那么如果想要提交数据给服务器应该怎么办呢？其实也不复杂，<strong>只需要将HTTP请求的方法改成POST</strong>，并在获取输入流之前把要提交的数据写出即可。注意，每条数据都要以键值对的形式存在，<strong>数据与数据之间用“&amp;”符号隔开</strong>。比如说我们想要向服务器提交用户名和密码，就可以这样写：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">connection.requestMethod = <span class="string">&quot;POST&quot;</span></span><br><span class="line"><span class="keyword">val</span> output = DataOutputStream(connection.outputStream)</span><br><span class="line">output.writeBytes(<span class="string">&quot;username=admin&amp;password=123456&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="2-2-使用OkHttp"><a href="#2-2-使用OkHttp" class="headerlink" title="2.2 使用OkHttp"></a>2.2 使用OkHttp</h3><p>当然我们并不是只能使用<strong>HttpURLConnection</strong>，完全没有任何其他选择，事实上在开源盛行的今天，有许多出色的网络通信库都可以替代原生的<strong>HttpURLConnection</strong>，而其中<strong>OkHttp</strong>无疑是做得最出色的一个。</p>
<p><strong>OkHttp</strong>是由鼎鼎大名的<strong>Square</strong>公司开发的，这个公司在开源事业上贡献良多，除了<strong>OkHttp</strong>之外，还开发了<strong>Retrofit</strong>、<strong>Picasso</strong>等知名的开源项目。<strong>OkHttp</strong>不仅在接口封装上做得简单易用，就连在底层实现上也是自成一派，比起原生的<strong>HttpURLConnection</strong>，可以说是有过之而无不及，现在已经成了广大<strong>Android</strong>开发者首选的网络通信库。那么本小节我们就来学习一下<strong>OkHttp</strong>的用法。<strong>OkHttp</strong>的项目主页地址是：<a target="_blank" rel="noopener" href="https://github.com/square/okhttp">OkHttp</a></p>
<p>在使用<strong>OkHttp</strong>之前，我们需要先在项目中添加<strong>OkHttp</strong>库的依赖。编辑<strong>app&#x2F;build.gradle</strong>文件，在<strong>dependencies</strong>闭包中添加如下内容：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation(&quot;com.squareup.okhttp3:okhttp:4.12.0&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加上述依赖会自动下载两个库：一个是OkHttp库，一个是Okio库.</p>
<p>下面我们来看一下<strong>OkHttp</strong>的具体用法，首先需要创建一个<strong>OkHttpClient</strong>的实例，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> client = OkHttpClient()</span><br></pre></td></tr></table></figure>

<p>接下来如果想要发起一条HTTP请求，就需要创建一个Request对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = Request.Builder().build()</span><br></pre></td></tr></table></figure>

<p>当然，上述代码只是创建了一个空的<strong>Request</strong>对象，并没有什么实际作用，我们可以在最终的<code>build()</code>方法之前连缀很多其他方法来丰富这个<strong>Request</strong>对象。比如可以通过<code>url()</code>方法来设置目标的网络地址，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">		.url(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">		.build()</span><br></pre></td></tr></table></figure>

<p>之后调用<strong>OkHttpClient</strong>的<code>newCall()</code>方法来创建一个<strong>Call</strong>对象，并调用它的<code>execute()</code>方法来发送请求并获取服务器返回的数据，写法如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> response = client.newCall(request).execute()</span><br></pre></td></tr></table></figure>

<p><strong>Response对象</strong>就是服务器返回的数据了，我们可以使用如下写法来得到返回的具体内容：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> responseData = response.body?.string()</span><br></pre></td></tr></table></figure>

<p>如果是发起一条<strong>POST</strong>请求，会比<strong>GET</strong>请求稍微复杂一点，<strong>我们需要先构建一个<code>Request Body</code>对象来存放待提交的参数，如下所示：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> requestBody = FormBody.Builder()</span><br><span class="line">		.add(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">		.add(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">		.build()</span><br></pre></td></tr></table></figure>

<p>然后在<strong>Request.Builder</strong>中调用一下<code>post()</code>方法，并将<strong>RequestBody</strong>对象传入：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">		.url(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">		.post(requestBody)</span><br><span class="line">		.build()</span><br></pre></td></tr></table></figure>

<p>接下来的操作就和<strong>GET</strong>请求一样了，调用<code>execute()</code>方法来发送请求并获取服务器返回的数据即可。</p>
<p>好了，<strong>OkHttp</strong>的基本用法就先学到这里，在本章的稍后部分我们还会学习<strong>OkHttp</strong>结合<strong>Retrofit</strong>的使用方法，到时候再进一步学习。那么现在我们先把<strong>NetworkTest</strong>这个项目改用<strong>OkHttp</strong>的方式再实现一遍吧。</p>
<p>代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line">            sendRequestWithHttpURLConnection()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithHttpURLConnection</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 开启线程发起网络请求</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">var</span> connection: HttpURLConnection? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/*val response = StringBuilder()</span></span><br><span class="line"><span class="comment">                val url = URL(&quot;https://icu007.work&quot;)</span></span><br><span class="line"><span class="comment">                connection = url.openConnection() as HttpURLConnection</span></span><br><span class="line"><span class="comment">                connection.connectTimeout = 8000</span></span><br><span class="line"><span class="comment">                connection.readTimeout = 8000</span></span><br><span class="line"><span class="comment">                val input = connection.inputStream</span></span><br><span class="line"><span class="comment">                // 下面对获取到的输入流进行读取</span></span><br><span class="line"><span class="comment">                val reader = BufferedReader(InputStreamReader(input))</span></span><br><span class="line"><span class="comment">                reader.use &#123;</span></span><br><span class="line"><span class="comment">                    reader.forEachLine &#123;</span></span><br><span class="line"><span class="comment">                        response.append(it)</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                showResponse(response.toString())*/</span></span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line">                    showResponse(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                connection?.disconnect()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showResponse</span><span class="params">(response: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        runOnUiThread &#123;</span><br><span class="line">            <span class="comment">// 在这里进行UI操作，将结果显示到界面上</span></span><br><span class="line">            mainBinding.responseText.text = response</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、解析XML格式数据"><a href="#三、解析XML格式数据" class="headerlink" title="三、解析XML格式数据"></a>三、解析XML格式数据</h2><p>通常情况下，每个需要访问网络的应用程序都会有一个自己的服务器，我们可以向服务器提交数据，也可以从服务器上获取数据。不过这个时候就出现了一个问题，这些数据到底要以什么样的格式在网络上传输呢？随便传递一段文本肯定是不行的，因为另一方根本就不知道这段文本的用途是什么。因此，一般我们会在网络上传输一些格式化后的数据，这种数据会有一定的结构规则和语义，当另一方收到数据消息之后，就可以按照相同的结构规则进行解析，从而取出想要的那部分内容。</p>
<p>在网络上传输数据时最常用的格式有两种：XML和JSON。下面我们就来一个一个地进行学习。本节首先学习一下如何解析XML格式的数据。</p>
<h3 id="3-0-准备工作-使用Apache服务器"><a href="#3-0-准备工作-使用Apache服务器" class="headerlink" title="3.0 准备工作(使用Apache服务器)"></a>3.0 准备工作(使用Apache服务器)</h3><p>在开始之前，我们还需要先解决一个问题，就是从哪儿才能获取一段XML格式的数据呢？这里我准备教你搭建一个最简单的Web服务器，在这个服务器上提供一段XML文本，然后我们在程序里去访问这个服务器，再对得到的XML文本进行解析。</p>
<p>搭建Web服务器的过程其实非常简单，也有很多种服务器类型可供选择，我们准备使用Apache服务器。另外，这里只会演示Windows系统下的搭建过程，因为Mac和Ubuntu系统都是默认安装好Apache服务器的，只需要启动一下即可。如果你使用的是这两种系统，可以自行搜索一下具体的操作方法。</p>
<p>下面来看Window系统下的搭建过程。首先你需要下载一个Apache服务器的安装包，官方下载地址是：<a target="_blank" rel="noopener" href="http://httpd.apache.org/">Apache官网</a>。但是在官网下载时我们会发现 <strong>Apache</strong> 本身已经不提供已编译的安装包了，只提供源码。但是他为我们推荐了第三方提供编译的网站：</p>
<p><a target="_blank" rel="noopener" href="https://www.apachelounge.com/download/">Apache VS17 binaries and modules download (apachelounge.com)</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708246917587_4cbfef9c5a33f.png" alt="1708246917587.png"></p>
<p>下载后解压打开Apache所在目录 conf中的<code>httpd.conf</code>文件有几个地方需要修改</p>
<ol>
<li><code>Define SRVROOT</code>： 需要改成自己Apache所在目录；</li>
<li><code>Listen</code>： 监听端口按需修改</li>
<li><code>ServerName</code>： 改为 <code>ServerName localhost:监听的端口号</code></li>
</ol>
<p>而后用 <strong>cmd</strong> 命令在 <code>Apache/bin/</code>目录下执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\httpd -k install</span><br></pre></td></tr></table></figure>

<p>出现如下字样且在浏览器打开设置的 ServerName 出现 <code>It works</code> 字样即安装成功</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708247243622_767268653e96e.png" alt="1708247243622.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708247536605_95af53b42e5b0.png" alt="1708247536605.png"></p>
<p>后续可以输入指令启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">httpd -k start  <span class="comment">#启动</span></span><br><span class="line">httpd -k stop   <span class="comment">#停止</span></span><br></pre></td></tr></table></figure>

<p>接下来在<code>Apache/htdocs</code>目录下，在这里新建一个名为<code>get_data.xml</code>的文件，然后编辑这个文件，并加入如下XML格式的内容。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">apps</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Google Maps<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Chrome<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>3<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Google Play<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">apps</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这时在浏览器中访问<a target="_blank" rel="noopener" href="http://servername/get_data.xml">http://ServerName/get_data.xml</a>这个网址，应出现如下所示内容</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708247707227_9f71538b612a7.png" alt="1708247707227.png"></p>
<h3 id="3-1-Pull解析方式"><a href="#3-1-Pull解析方式" class="headerlink" title="3.1 Pull解析方式"></a>3.1 Pull解析方式</h3><p>解析XML格式的数据其实也有挺多种方式的，本节中我们学习比较常用的两种：<strong>Pull解析</strong>和<strong>SAX解析</strong>。那么简单起见，这里仍然是在<strong>NetworkTest</strong>项目的基础上继续开发，这样我们就可以重用之前网络通信部分的代码，从而把工作的重心放在XML数据解析上。</p>
<p>既然XML格式的数据已经提供好了，现在要做的就是从中解析出我们想要得到的那部分内容。修改<strong>MainActivity</strong>中的代码，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParser</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserFactory</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader</span><br><span class="line"><span class="keyword">import</span> java.lang.StringBuilder</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line"><span class="comment">//            sendRequestWithHttpURLConnection()</span></span><br><span class="line">            sendRequestWithOkHttp()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithHttpURLConnection</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// 开启线程发起网络请求</span></span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">var</span> connection: HttpURLConnection? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">/*val response = StringBuilder()</span></span><br><span class="line"><span class="comment">                val url = URL(&quot;https://icu007.work&quot;)</span></span><br><span class="line"><span class="comment">                connection = url.openConnection() as HttpURLConnection</span></span><br><span class="line"><span class="comment">                connection.connectTimeout = 8000</span></span><br><span class="line"><span class="comment">                connection.readTimeout = 8000</span></span><br><span class="line"><span class="comment">                val input = connection.inputStream</span></span><br><span class="line"><span class="comment">                // 下面对获取到的输入流进行读取</span></span><br><span class="line"><span class="comment">                val reader = BufferedReader(InputStreamReader(input))</span></span><br><span class="line"><span class="comment">                reader.use &#123;</span></span><br><span class="line"><span class="comment">                    reader.forEachLine &#123;</span></span><br><span class="line"><span class="comment">                        response.append(it)</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                showResponse(response.toString())*/</span></span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;https://icu007.work&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line">                    showResponse(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                connection?.disconnect()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithOkHttp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;http:/10.0.2.2:8088/get_data.xml&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;sendRequestWithOkHttp: <span class="variable">$responseData</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line">                    parseXMLWithPull(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showResponse</span><span class="params">(response: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        runOnUiThread &#123;</span><br><span class="line">            <span class="comment">// 在这里进行UI操作，将结果显示到界面上</span></span><br><span class="line">            mainBinding.responseText.text = response</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">parseXMLWithPull</span><span class="params">(xmlData: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> factory = XmlPullParserFactory.newInstance()</span><br><span class="line">            <span class="keyword">val</span> xmlPullParser = factory.newPullParser()</span><br><span class="line">            xmlPullParser.setInput(StringReader(xmlData))</span><br><span class="line">            <span class="keyword">var</span> eventType = xmlPullParser.eventType</span><br><span class="line">            <span class="keyword">var</span> id = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">var</span> name = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">var</span> version = <span class="string">&quot;&quot;</span></span><br><span class="line">            <span class="keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                <span class="keyword">val</span> nodeName = xmlPullParser.name</span><br><span class="line">                <span class="keyword">when</span> (eventType) &#123;</span><br><span class="line">                    <span class="comment">// 开始解析某个节点</span></span><br><span class="line">                    XmlPullParser.START_TAG -&gt; &#123;</span><br><span class="line">                        <span class="keyword">when</span> (nodeName) &#123;</span><br><span class="line">                            <span class="string">&quot;id&quot;</span> -&gt; id = xmlPullParser.nextText()</span><br><span class="line">                            <span class="string">&quot;name&quot;</span> -&gt; name = xmlPullParser.nextText()</span><br><span class="line">                            <span class="string">&quot;version&quot;</span> -&gt; version = xmlPullParser.nextText()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 完成解析某个节点</span></span><br><span class="line">                    XmlPullParser.END_TAG -&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">&quot;app&quot;</span> == nodeName) &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;id is <span class="variable">$id</span>&quot;</span>)</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;name is <span class="variable">$name</span>&quot;</span>)</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;version is <span class="variable">$version</span>&quot;</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                eventType = xmlPullParser.next()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<strong>这里首先将HTTP请求的地址改成了<a target="_blank" rel="noopener" href="http://10.0.2.2/get_data.xml%EF%BC%8C10.0.2.2">http://10.0.2.2/get_data.xml，10.0.2.2</a>对于模拟器来说就是计算机本机的IP地址</strong>。在得到了服务器返回的数据后，我们不再直接将其展示，而是调用了<code>parseXMLWithPull()</code>方法来解析服务器返回的数据。</p>
<p>下面就来仔细看下<code>parseXMLWithPull()</code>方法中的代码吧。这里首先要创建一个<strong>XmlPullParserFactory</strong>的实例，并借助这个实例得到<strong>XmlPullParser</strong>对象，然后调用<strong>XmlPullParser</strong>的<code>setInput()</code>方法将服务器返回的XML数据设置进去，之后就可以开始解析了。解析的过程也非常简单，通过<code>getEventType()</code>可以得到当前的解析事件，然后在一个<strong>while</strong>循环中不断地进行解析，如果当前的解析事件不等于<code>XmlPullParser.END_DOCUMENT</code>，说明解析工作还没完成，调用<code>next()</code>方法后可以获取下一个解析事件。</p>
<p>在<strong>while</strong>循环中，我们通过<code>getName()</code>方法得到了当前节点的名字。如果发现节点名等于<strong>id、name或version</strong>，就调用<code>nextText()</code>方法来获取节点内具体的内容，每当解析完一个<strong>app</strong>节点，就将获取到的内容打印出来。</p>
<p>好了，整体的过程就是这么简单，不过在程序运行之前还得再进行一项额外的配置。从Android9.0系统开始，应用程序默认只允许使用HTTPS类型的网络请求，HTTP类型的网络请求因为有安全隐患默认不再被支持，而我们搭建的Apache服务器现在使用的就是HTTP。</p>
<p>那么为了能让程序使用HTTP，我们还要进行如下配置才可以。右击<strong>res目录→New→Directory</strong>，创建一个xml目录，接着<strong>右击xml目录→New→File</strong>，创建一个<code>network_config.xml</code>文件。然后修改<code>network_config.xml</code>文件中的内容，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段配置文件的意思就是允许我们以明文的方式在网络上传输数据，而HTTP使用的就是明文传输方式。</p>
<p>接下来修改<code>AndroidManifest.xml</code>中的代码来启用我们刚才创建的配置文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.NetworkTest&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:networkSecurityConfig</span>=<span class="string">&quot;@xml/network_config&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行NetworkTest项目，然后点击“Send Request”按钮，观察Logcat中的打印日志.</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  id is 1</span><br><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  name is Google Maps</span><br><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  version is 1.0</span><br><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  id is 2</span><br><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  name is Chrome</span><br><span class="line">2024-02-19 11:21:59.080  7199-7307  MainActivity            work.icu007.networktest              D  version is 2.1</span><br><span class="line">2024-02-19 11:21:59.081  7199-7307  MainActivity            work.icu007.networktest              D  id is 3</span><br><span class="line">2024-02-19 11:21:59.081  7199-7307  MainActivity            work.icu007.networktest              D  name is Google Play</span><br><span class="line">2024-02-19 11:21:59.081  7199-7307  MainActivity            work.icu007.networktest              D  version is 2.3</span><br></pre></td></tr></table></figure>

<p>可以看到，XML数据中的指定内容已经解析出来了。</p>
<h3 id="3-2-SAX解析方式"><a href="#3-2-SAX解析方式" class="headerlink" title="3.2 SAX解析方式"></a>3.2 SAX解析方式</h3><p><strong>Pull</strong>解析方式虽然非常好用，但它并不是我们唯一的选择。<strong>SAX</strong>解析也是一种特别常用的<strong>XML</strong>解析方式，虽然它的用法比<strong>Pull</strong>解析要复杂一些，但在语义方面会更加清楚。要使用<strong>SAX</strong>解析，通常情况下我们会新建一个类继承自<code>DefaultHandler</code>，并重写父类的5个方法，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Author: Charlie_Liao</span></span><br><span class="line"><span class="comment"> * Time: 2024/2/19-11:33</span></span><br><span class="line"><span class="comment"> * E-mail: rookie_l@icu007.work</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span> : <span class="type">DefaultHandler</span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">startDocument</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.startDocument()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">endDocument</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.endDocument()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">startElement</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        uri: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        localName: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        qName: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        attributes: <span class="type">Attributes</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.startElement(uri, localName, qName, attributes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">endElement</span><span class="params">(uri: <span class="type">String</span>?, localName: <span class="type">String</span>?, qName: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.endElement(uri, localName, qName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">characters</span><span class="params">(ch: <span class="type">CharArray</span>?, start: <span class="type">Int</span>, length: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.characters(ch, start, length)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startDocument()</code>方法会在开始<strong>XML</strong>解析的时候调用，<code>startElement()</code>方法会在开始解析某个节点的时候调用，<code>characters()</code>方法会在获取节点中内容的时候调用，<code>endElement()</code>方法会在完成解析某个节点的时候调用，<code>endDocument()</code>方法会在完成整个<strong>XML</strong>解析的时候调用。其中，<code>startElement()</code>、<code>characters()</code>和<code>endElement()</code>这3个方法是有参数的，从<strong>XML</strong>中解析出的数据就会以参数的形式传入这些方法中。需要注意的是，在获取节点中的内容时，<code>characters()</code>方法可能会被调用多次，一些换行符也被当作内容解析出来，我们需要针对这种情况在代码中做好控制。</p>
<p>那么下面就让我们尝试用SAX解析的方式来实现和上一小节同样的功能吧。新建一个<code>ContentHandler</code>类继承自<code>DefaultHandler</code>，并重写父类的5个方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler</span><br><span class="line"><span class="keyword">import</span> java.lang.StringBuilder</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Author: Charlie_Liao</span></span><br><span class="line"><span class="comment"> * Time: 2024/2/19-11:33</span></span><br><span class="line"><span class="comment"> * E-mail: rookie_l@icu007.work</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContentHandler</span> : <span class="type">DefaultHandler</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> nodeName = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> id: StringBuilder</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> name: StringBuilder</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> version: StringBuilder</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">startDocument</span><span class="params">()</span></span> &#123;</span><br><span class="line">        id = StringBuilder()</span><br><span class="line">        name = StringBuilder()</span><br><span class="line">        version = StringBuilder()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">endDocument</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.endDocument()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">startElement</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        uri: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        localName: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        qName: <span class="type">String</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        attributes: <span class="type">Attributes</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localName != <span class="literal">null</span>)&#123;</span><br><span class="line">            nodeName = localName</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;startElement: uri is <span class="variable">$uri</span>&quot;</span>)</span><br><span class="line">        Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;startElement: localName is <span class="variable">$localName</span>&quot;</span>)</span><br><span class="line">        Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;startElement: qName is <span class="variable">$qName</span>&quot;</span>)</span><br><span class="line">        Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;startElement: attributes is <span class="variable">$attributes</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">endElement</span><span class="params">(uri: <span class="type">String</span>?, localName: <span class="type">String</span>?, qName: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;app&quot;</span> == localName) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;endElement: id is <span class="subst">$&#123;id.toString().trim()&#125;</span>&quot;</span>)</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;endElement: name is <span class="subst">$&#123;name.toString().trim()&#125;</span>&quot;</span>)</span><br><span class="line">            Log.d(<span class="string">&quot;ContentHandler&quot;</span>, <span class="string">&quot;endElement: version is <span class="subst">$&#123;version.toString().trim()&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="comment">// 最后将StringBuilder清空</span></span><br><span class="line">            id.setLength(<span class="number">0</span>)</span><br><span class="line">            name.setLength(<span class="number">0</span>)</span><br><span class="line">            version.setLength(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">characters</span><span class="params">(ch: <span class="type">CharArray</span>?, start: <span class="type">Int</span>, length: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">when</span>(nodeName) &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span> -&gt; id.append(ch, start, length)</span><br><span class="line">            <span class="string">&quot;name&quot;</span> -&gt; name.append(ch, start, length)</span><br><span class="line">            <span class="string">&quot;version&quot;</span> -&gt; version.append(ch, start, length)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们首先给<strong>id</strong>、<strong>name</strong>和<strong>version</strong>节点分别定义了一个<strong>StringBuilder</strong>对象，并在<code>startDocument()</code>方法里对它们进行了初始化。每当开始解析某个节点的时候，<code>startElement()</code>方法就会得到调用，其中<strong>localName</strong>参数记录着当前节点的名字，这里我们把它记录下来。接着在解析节点中具体内容的时候就会调用<code>characters()</code>方法，我们会根据当前的节点名进行判断，将解析出的内容添加到哪一个<strong>StringBuilder</strong>对象中。最后在<code>endElement()</code>方法中进行判断，如果app节点已经解析完成，就打印出id、name和version的内容。需要注意的是，目前<strong>id</strong>、<strong>name</strong>和<strong>version</strong>中都可能是包括回车或换行符的，因此在打印之前我们还需要调用一下<code>trim()</code>方法，并且打印完成后要将<strong>StringBuilder</strong>的内容清空，不然的话会影响下一次内容的读取。</p>
<p>接下来的工作就非常简单了，修改<strong>MainActivity</strong>中的代码，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParser</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserFactory</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader</span><br><span class="line"><span class="keyword">import</span> java.lang.StringBuilder</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line"><span class="comment">//            sendRequestWithHttpURLConnection()</span></span><br><span class="line">            sendRequestWithOkHttp()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithOkHttp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;http:/10.0.2.2:8088/get_data.xml&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;sendRequestWithOkHttp: <span class="variable">$responseData</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//                    parseXMLWithPull(responseData)</span></span><br><span class="line">                    parseXMLWithSAX(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">parseXMLWithSAX</span><span class="params">(xmlData: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> factory = SAXParserFactory.newInstance()</span><br><span class="line">            <span class="keyword">val</span> xmlReader = factory.newSAXParser().xmlReader</span><br><span class="line">            <span class="keyword">val</span> handler = ContentHandler()</span><br><span class="line">            xmlReader.contentHandler = handler</span><br><span class="line">            xmlReader.parse(InputSource(StringReader(xmlData)))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在得到了服务器返回的数据后，我们这次通过调用<code>parseXMLWithSAX()</code>方法来解析XML数据。<code>parseXMLWithSAX()</code>方法中先是创建了一个<strong>SAXParserFactory</strong>的对象，然后再获取<strong>XMLReader</strong>对象，接着将我们编写的<strong>ContentHandler</strong>的实例设置到<strong>XMLReader</strong>中，最后调用<code>parse()</code>方法开始执行解析。观察log会发现结果和Pull解析是一致的。</p>
<hr>
<h2 id="四、解析JSON格式数据"><a href="#四、解析JSON格式数据" class="headerlink" title="四、解析JSON格式数据"></a>四、解析JSON格式数据</h2><p>现在你已经掌握了<strong>XML</strong>格式数据的解析方式，那么接下来我们要学习一下如何解析<strong>JSON</strong>格式的数据了。比起<strong>XML</strong>，<strong>JSON</strong>的主要优势在于它的体积更小，在网络上传输的时候更省流量。但缺点在于，它的语义性较差，看起来不如<strong>XML</strong>直观。</p>
<p>在开始之前，我们还需要在<code>Apache/htdocs</code>目录中新建一个<code>get_data.json</code>的文件，然后编辑这个文件，并加入如下<strong>JSON</strong>格式的内容：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;5&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;5.5&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Clash of Clans&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;6&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;7.0&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Boom Beach&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;7&quot;</span><span class="punctuation">,</span><span class="attr">&quot;version&quot;</span><span class="punctuation">:</span><span class="string">&quot;3.5&quot;</span><span class="punctuation">,</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Clash Royale&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<h3 id="4-1-使用JSONObject"><a href="#4-1-使用JSONObject" class="headerlink" title="4.1 使用JSONObject"></a>4.1 使用JSONObject</h3><p>解析<strong>JSON</strong>数据也有很多种方法，可以使用官方提供的<strong>JSONObject</strong>，也可以使用<strong>Google</strong>的开源库<strong>GSON</strong>。另外，一些第三方的开源库如<strong>Jackson</strong>、<strong>FastJSON</strong>等也非常不错。本节中我们就来学习一下前两种解析方式的用法。</p>
<p>修改<strong>MainActivity</strong>中的代码，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request</span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParser</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserFactory</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader</span><br><span class="line"><span class="keyword">import</span> java.lang.StringBuilder</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line"><span class="comment">//            sendRequestWithHttpURLConnection()</span></span><br><span class="line">            sendRequestWithOkHttp()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithOkHttp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;http:/10.0.2.2:8088/get_data.json&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;sendRequestWithOkHttp: <span class="variable">$responseData</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//                    parseXMLWithPull(responseData)</span></span><br><span class="line"><span class="comment">//                    parseXMLWithSAX(responseData)</span></span><br><span class="line">                    parseJSONWithJSONObject(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">parseJSONWithJSONObject</span><span class="params">(jsonData: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> jsonArray = JSONArray(jsonData)</span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until jsonArray.length()) &#123;</span><br><span class="line">                <span class="keyword">val</span> jsonObject = jsonArray.getJSONObject(i)</span><br><span class="line">                <span class="keyword">val</span> id = jsonObject.getString(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                <span class="keyword">val</span> name = jsonObject.getString(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">                <span class="keyword">val</span> version = jsonObject.getString(<span class="string">&quot;version&quot;</span>)</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithJSONObject: id is <span class="variable">$id</span>&quot;</span>)</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithJSONObject: name is <span class="variable">$name</span>&quot;</span>)</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithJSONObject: version is <span class="variable">$version</span>&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先将HTTP请求的地址改成<a target="_blank" rel="noopener" href="http://10.0.2.2/get_data.json">http://10.0.2.2/get_data.json</a>，然后在得到服务器返回的数据后调用<code>parseJSONWithJSONObject()</code>方法来解析数据。可以看到，解析<strong>JSON</strong>的代码真的非常简单，由于我们在服务器中定义的是一个<strong>JSON</strong>数组，因此这里首先将服务器返回的数据传入一个<strong>JSONArray</strong>对象中。然后循环遍历这个<strong>JSONArray</strong>，从中取出的每一个元素都是一个<strong>JSONObject</strong>对象，每个<strong>JSONObject</strong>对象中又会包含<strong>id、name和version</strong>这些数据。接下来只需要调用<code>getString()</code>方法将这些数据取出，并打印出来即可。</p>
<p>运行结果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/user/xiheya/2024/02/1708323342502_06812d6513a1c.png" alt="1708323342502.png"></p>
<h3 id="4-2-使用GSON"><a href="#4-2-使用GSON" class="headerlink" title="4.2 使用GSON"></a>4.2 使用GSON</h3><p>使用<strong>JSONObject</strong>来解析<strong>JSON</strong>数据已经非常简单了，但是<strong>Google</strong>提供的<strong>GSON</strong>开源库可以让解析<strong>JSON</strong>数据的工作简单到让你不敢想象的地步。<a target="_blank" rel="noopener" href="https://github.com/google/gson">GSON仓库</a></p>
<p>不过，<strong>GSON</strong>并没有被添加到<strong>Android</strong>官方的<strong>API</strong>中，因此如果想要使用这个功能的话，就必须在项目中添加<strong>GSON</strong>库的依赖。编辑<code>app/build.gradle</code>文件，在<strong>dependencies</strong>闭包中添加如下内容：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation(&quot;com.google.code.gson:gson:2.10.1&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么GSON库究竟是神奇在哪里呢？它的强大之处就在于可以将一段JSON格式的字符串自动映射成一个对象，从而不需要我们再手动编写代码进行解析了。比如说一段JSON格式的数据如下所示：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tom&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>那我们就可以定义一个<strong>Person</strong>类，并加入<strong>name</strong>和<strong>age</strong>这两个字段，然后只需简单地调用如下代码就可以将<strong>JSON</strong>数据自动解析成一个<strong>Person</strong>对象了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> gson = Gson()</span><br><span class="line"><span class="keyword">val</span> person = gson.fromJson(jsonData, Person::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>

<p>如果需要解析的是一段<strong>JSON</strong>数组，会稍微麻烦一点，比如如下格式的数据：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tom&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Jack&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">25</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span><span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Lily&quot;</span><span class="punctuation">,</span><span class="attr">&quot;age&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>这个时候，我们需要借助<strong>TypeToken</strong>将期望解析成的数据类型传入<code>fromJson()</code>方法中，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> typeOf = <span class="keyword">object</span> : TypeToken&lt;List&lt;Person&gt;&gt;() &#123;&#125;.type</span><br><span class="line"><span class="keyword">val</span> people = gson.fromJson&lt;List&lt;Person&gt;&gt;(jsonData, typeOf)</span><br></pre></td></tr></table></figure>

<p>好了，基本的用法就是这样，下面就让我们来真正地尝试一下。首先新增一个App类，并加入id、name和version这3个字段，如下所示:</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">App</span>(<span class="keyword">val</span> id: String, <span class="keyword">val</span> name: String, <span class="keyword">val</span> version: String)</span><br></pre></td></tr></table></figure>

<p>然后修改MainActivity中的代码，如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.networktest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> com.google.gson.Gson</span><br><span class="line"><span class="keyword">import</span> com.google.gson.reflect.TypeToken</span><br><span class="line"><span class="keyword">import</span> okhttp3.OkHttpClient</span><br><span class="line"><span class="keyword">import</span> okhttp3.Request</span><br><span class="line"><span class="keyword">import</span> org.json.JSONArray</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.InputSource</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParser</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserFactory</span><br><span class="line"><span class="keyword">import</span> work.icu007.networktest.databinding.ActivityMainBinding</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader</span><br><span class="line"><span class="keyword">import</span> java.io.StringReader</span><br><span class="line"><span class="keyword">import</span> java.lang.StringBuilder</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection</span><br><span class="line"><span class="keyword">import</span> java.net.URL</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory</span><br><span class="line"><span class="keyword">import</span> kotlin.concurrent.thread</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line">        mainBinding.sendRequestBtn.setOnClickListener &#123;</span><br><span class="line"><span class="comment">//            sendRequestWithHttpURLConnection()</span></span><br><span class="line">            sendRequestWithOkHttp()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">sendRequestWithOkHttp</span><span class="params">()</span></span> &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">                <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">                    .url(<span class="string">&quot;http:/10.0.2.2:8088/get_data.json&quot;</span>)</span><br><span class="line">                    .build()</span><br><span class="line">                <span class="keyword">val</span> response = client.newCall(request).execute()</span><br><span class="line">                <span class="keyword">val</span> responseData = response.body?.string()</span><br><span class="line">                Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;sendRequestWithOkHttp: <span class="variable">$responseData</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (responseData != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">//                    parseXMLWithPull(responseData)</span></span><br><span class="line"><span class="comment">//                    parseXMLWithSAX(responseData)</span></span><br><span class="line"><span class="comment">//                    parseJSONWithJSONObject(responseData)</span></span><br><span class="line">                    parseJSONWithGSON(responseData)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">parseJSONWithGSON</span><span class="params">(jsonData: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> gson = Gson()</span><br><span class="line">        <span class="keyword">val</span> typeOf = <span class="keyword">object</span> : TypeToken&lt;List&lt;App&gt;&gt;() &#123;&#125;.type</span><br><span class="line">        <span class="keyword">val</span> appList = gson.fromJson&lt;List&lt;App&gt;&gt;(jsonData, typeOf)</span><br><span class="line">        <span class="keyword">for</span> (app <span class="keyword">in</span> appList) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithGSON: id is <span class="subst">$&#123;app.id&#125;</span>&quot;</span>)</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithGSON: name is <span class="subst">$&#123;app.name&#125;</span>&quot;</span>)</span><br><span class="line">            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;parseJSONWithGSON: version is <span class="subst">$&#123;app.version&#125;</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察打印日志，与使用JSONObject结果一致。</p>
<hr>
<h2 id="五、网络请求回调的实现方式"><a href="#五、网络请求回调的实现方式" class="headerlink" title="五、网络请求回调的实现方式"></a>五、网络请求回调的实现方式</h2><p>目前我们已经掌握了<strong>HttpURLConnection</strong>和<strong>OkHttp</strong>的用法，知道了如何发起<strong>HTTP</strong>请求，以及解析服务器返回的数据，但之前我们的写法其实是很有问题的。因为一个应用程序很可能会在许多地方都使用到网络功能，而发送<strong>HTTP</strong>请求的代码基本是相同的，如果我们每次都去编写一遍发送<strong>HTTP</strong>请求的代码，这显然是非常差劲的做法。</p>
<p>没错，通常情况下我们应该将这些通用的网络操作提取到一个公共的类里，并提供一个通用方法，当想要发起网络请求的时候，只需简单地调用一下这个方法即可。比如使用如下的写法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> HttpUtil &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendHttpRequest</span> <span class="params">(address: <span class="type">String</span>)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">var</span> connection: HttpURLConnection? = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> response = StringBuilder()</span><br><span class="line">            <span class="keyword">val</span> url = URL(address)</span><br><span class="line">            connection = url.openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">            connection.connectTimeout = <span class="number">8000</span></span><br><span class="line">            connection.readTimeout = <span class="number">8000</span></span><br><span class="line">            <span class="keyword">val</span> input = connection.inputStream</span><br><span class="line">            <span class="keyword">val</span> reader = BufferedReader(InputStreamReader(input))</span><br><span class="line">            reader.use &#123;</span><br><span class="line">                reader.forEachLine &#123;</span><br><span class="line">                    response.append(it)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.toString()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">            <span class="keyword">return</span> e.message.toString()</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            connection?.disconnect()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以后每当需要发起一条<strong>HTTP</strong>请求的时候，就可以这样写：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> address = <span class="string">&quot;https://icu007.work&quot;</span></span><br><span class="line"><span class="keyword">val</span> response = HttpUtil.sendHttpRequest(address)</span><br></pre></td></tr></table></figure>

<p>在获取到服务器响应的数据后，我们就可以对它进行解析和处理了。但是需要注意，网络请求通常属于耗时操作，而<code>sendHttpRequest()</code>方法的内部并没有开启线程，这样就有可能导致在调用<code>sendHttpRequest()</code>方法的时候主线程被阻塞。</p>
<p>那在<code>sendHttpRequest()</code>方法内部开启一个线程，不就解决这个问题了吗？其实没有想象中那么容易，因为如果我们在<code>sendHttpRequest()</code>方法中开启一个线程来发起<strong>HTTP</strong>请求，服务器响应的数据是无法进行返回的。这是由于所有的耗时逻辑都是在子线程里进行的，<code>sendHttpRequest()</code>方法会在服务器还没来得及响应的时候就执行结束了，当然也就无法返回响应的数据了。</p>
<p>那么在遇到这种情况时应该怎么办呢？其实解决方法并不难，只需要使用编程语言的回调机制就可以了。下面就来学习一下回调机制到底是如何使用的。</p>
<p>首先需要定义一个接口，比如将它命名成<code>HttpCallbackListener</code>，代码如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">HttpCallbackListener</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onFinish</span><span class="params">(response: <span class="type">String</span>)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Exception</span>)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们在接口中定义了两个方法：<code>onFinish()</code>方法表示当服务器成功响应我们请求的时候调用，<code>onError()</code>表示当进行网络操作出现错误的时候调用。这两个方法都带有参数，<code>onFinish()</code>方法中的参数代表服务器返回的数据，而<code>onError()</code>方法中的参数记录着错误的详细信息。</p>
<p>接着修改<code>HttpUtil</code>中的代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">HttpCallbackListener</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onFinish</span><span class="params">(response: <span class="type">String</span>)</span></span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Exception</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">object</span> HttpUtil &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendHttpRequest</span> <span class="params">(address: <span class="type">String</span>, listener: <span class="type">HttpCallbackListener</span>)</span></span> &#123;</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">var</span> connection: HttpURLConnection? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> response = StringBuilder()</span><br><span class="line">                <span class="keyword">val</span> url = URL(address)</span><br><span class="line">                connection = url.openConnection() <span class="keyword">as</span> HttpURLConnection</span><br><span class="line">                connection.connectTimeout = <span class="number">8000</span></span><br><span class="line">                connection.readTimeout = <span class="number">8000</span></span><br><span class="line">                <span class="keyword">val</span> input = connection.inputStream</span><br><span class="line">                <span class="keyword">val</span> reader = BufferedReader(InputStreamReader(input))</span><br><span class="line">                reader.use &#123;</span><br><span class="line">                    reader.forEachLine &#123;</span><br><span class="line">                        response.append(it)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                listener.onFinish(response.toString())</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">                listener.onError(e)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                connection?.disconnect()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们首先给<code>sendHttpRequest()</code>方法添加了一个<code>HttpCallbackListener</code>参数，并在方法的内部开启了一个子线程，然后在子线程里执行具体的网络操作。注意，<strong>子线程中是无法通过return语句返回数据的</strong>，因此这里我们将服务器响应的数据传入了<code>HttpCallbackListener</code>的<code>onFinish()</code>方法中，如果出现了异常，就将异常原因传入<code>onError()</code>方法中。</p>
<p>现在<code>sendHttpRequest()</code>方法接收两个参数，因此我们在调用它的时候还需要将<code>HttpCallbackListener</code>的实例传入，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HttpUtil.sendHttpRequest(address, <span class="keyword">object</span>: HttpCallbackListener&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onError</span><span class="params">(e: <span class="type">Exception</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 对异常情况进行处理</span></span><br><span class="line">        TODO(<span class="string">&quot;Not yet implemented&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFinish</span><span class="params">(response: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 得到服务器返回的具体内容</span></span><br><span class="line">        TODO(<span class="string">&quot;Not yet implemented&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>这样当服务器成功响应的时候，我们就可以在<code>onFinish()</code>方法里对响应数据进行处理了。类似地，如果出现了异常，就可以在<code>onError()</code>方法里对异常情况进行处理。如此一来，我们就巧妙地利用回调机制将响应数据成功返回给调用方了。</p>
<p>不过你会发现，上述使用<code>HttpURLConnection</code>的写法总体来说还是比较复杂的，那么使用<code>OkHttp</code>会变得简单吗？答案是肯定的，而且要简单得多，下面我们来具体看一下。在<code>HttpUtil</code>中加入一个<code>sendOkHttpRequest()</code>方法，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> HttpUtil &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">sendOkHttpRequest</span><span class="params">(address: <span class="type">String</span>, callback: <span class="type">okhttp3</span>.<span class="type">Callback</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> client = OkHttpClient()</span><br><span class="line">        <span class="keyword">val</span> request = Request.Builder()</span><br><span class="line">            .url(address)</span><br><span class="line">            .build()</span><br><span class="line">        client.newCall(request).enqueue(callback)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>sendOkHttpRequest()</code>方法中有一个<code>okhttp3.Callback</code>参数，这个是<code>OkHttp</code>库中自带的回调接口，类似于我们刚才自己编写的<code>HttpCallbackListener</code>。然后在<code>client.newCall()</code>之后没有像之前那样一直调用<code>execute()</code>方法，而是调用了一个<code>enqueue()</code>方法，并把<code>okhttp3.Callback</code>参数传入。OkHttp<code>在</code>enqueue()<code>方法的内部已经帮我们开好子线程了，然后会在子线程中执行HTTP请求，并将最终的请求结果回调到</code>okhttp3.Callback&#96;当中。**</p>
<p>那么我们在调用<code>sendOkHttpRequest()</code>方法的时候就可以这样写：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HttpUtil.sendOkHttpRequest(address, <span class="keyword">object</span> : Callback &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>, response: <span class="type">Response</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 得到服务器返回的具体内容</span></span><br><span class="line">        TODO(<span class="string">&quot;Not yet implemented&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(call: <span class="type">Call</span>, e: <span class="type">IOException</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 进行异常情况处理</span></span><br><span class="line">        TODO(<span class="string">&quot;Not yet implemented&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>由此可以看出，<code>OkHttp</code>的接口设计得确实非常人性化，它将一些常用的功能进行了很好的封装，使得我们只需编写少量的代码就能完成较为复杂的网络操作。</p>
<p>另外，需要注意的是，不管是使用<code>HttpURLConnection</code>还是<code>OkHttp</code>，最终的回调接口都还是在子线程中运行的，因此我们不可以在这里执行任何的UI操作，除非借助<code>runOnUiThread()</code>方法来进行类型转换。</p>
<h2 id="六、最好用的网络库：-Retrofit"><a href="#六、最好用的网络库：-Retrofit" class="headerlink" title="六、最好用的网络库： Retrofit"></a>六、最好用的网络库： Retrofit</h2><p>既然学习<strong>Android</strong>网络技术，那么就不得不提到<code>Retrofit</code>，因为它实在是太好用了。<code>Retrofit</code>同样是一款由<strong>Square</strong>公司开发的网络库，但是它和<code>OkHttp</code>的定位完全不同。<code>OkHttp</code>侧重的是底层通信的实现，而<code>Retrofit</code>侧重的是上层接口的封装。事实上，<code>Retrofit</code>就是<strong>Square</strong>公司在<code>OkHttp</code>的基础上进一步开发出来的应用层网络通信库，使得我们可以用更加面向对象的思维进行网络操作。<code>Retrofit</code>的项目主页地址是：<a target="_blank" rel="noopener" href="https://github.com/square/retrofit">GitHub仓库</a></p>
<h3 id="6-1-Retrofit的基本用法"><a href="#6-1-Retrofit的基本用法" class="headerlink" title="6.1 Retrofit的基本用法"></a>6.1 Retrofit的基本用法</h3><p><code>Retrofit</code>的设计基于以下几个事实：</p>
<ol>
<li>同一款应用程序中所发起的网络请求绝大多数指向的是同一个服务器域名。这个很好理解，因为任何公司的产品，客户端和服务器都是配套的，很难想象一个客户端一会去这个服务器获取数据，一会又要去另外一个服务器获取数据吧？</li>
<li>另外，服务器提供的接口通常是可以根据功能来归类的。比如新增用户、修改用户数据、查询用户数据这几个接口就可以归为一类，上架新书、销售图书、查询可供销售图书这几个接口也可以归为一类。将服务器接口合理归类能够让代码结构变得更加合理，从而提高可阅读性和可维护性。</li>
<li>最后，开发者肯定更加习惯于“调用一个接口，获取它的返回值”这样的编码方式，但当调用的是服务器接口时，却很难想象该如何使用这样的编码方式。其实大多数人并不关心网络的具体通信细节，但是传统网络库的用法却需要编写太多网络相关的代码。</li>
</ol>
<p>而<code>Retrofit</code>的用法就是基于以上几点来设计的，首先我们可以配置好一个根路径，然后在指定服务器接口地址时只需要使用相对路径即可，这样就不用每次都指定完整的<strong>URL</strong>地址了。</p>
<p>另外，<code>Retrofit</code>允许我们对服务器接口进行归类，将功能同属一类的服务器接口定义到同一个接口文件当中，从而让代码结构变得更加合理。</p>
<p>最后，我们也完全不用关心网络通信的细节，只需要在接口文件中声明一系列方法和返回值，然后通过注解的方式指定该方法对应哪个服务器接口，以及需要提供哪些参数。当我们在程序中调用该方法时，<code>Retrofit</code>会自动向对应的服务器接口发起请求，并将响应的数据解析成返回值声明的类型。这就使得我们可以用更加面向对象的思维来进行网络操作。</p>
<p><code>Retrofit</code>的基本设计思想差不多就是这些，下面就通过一个具体的例子来快速体验一下<code>Retrofit</code>的用法。</p>
<p>要想使用<code>Retrofit</code>，我们需要先在项目中添加必要的依赖库。编辑<code>app/build.gradle</code>文件，在<strong>dependencies</strong>闭包中添加如下内容：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    implementation(&quot;com.squareup.retrofit2:retrofit:2.9.0&quot;)</span><br><span class="line">    implementation(&quot;com.squareup.retrofit2:converter-gson:2.9.0&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于<code>Retrofit</code>是基于<code>OkHttp</code>开发的，因此添加上述第一条依赖会自动将<code>Retrofit</code>、<code>OkHttp</code>和<code>Okio</code>这几个库一起下载，我们无须再手动引入<code>OkHttp</code>库。另外，<code>Retrofit</code>还会将服务器返回的<strong>JSON</strong>数据自动解析成对象，因此上述第二条依赖就是一个<code>Retrofit</code>的转换库，它是借助<code>GSON</code>来解析<strong>JSON</strong>数据的，所以会自动将<code>GSON</code>库一起下载下来，这样我们也不用手动引入<code>GSON</code>库了。除了<code>GSON</code>之外，<code>Retrofit</code>还支持各种其他主流的<strong>JSON</strong>解析库，包括<code>Jackson</code>、<code>Moshi</code>等，不过毫无疑问<code>GSON</code>是最常用的。</p>
<p>我们使用之前提供的<strong>JSON</strong>数据接口。由于<code>Retrofit</code>会借助<code>GSON</code>将<strong>JSON</strong>数据转换成对象，因此这里同样需要新增一个<strong>App</strong>类，并加入<strong>id</strong>、<strong>name</strong>和<strong>version</strong>这3个字段，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.retrofittest</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Author: Charlie_Liao</span></span><br><span class="line"><span class="comment"> * Time: 2024/2/19-15:23</span></span><br><span class="line"><span class="comment"> * E-mail: rookie_l@icu007.work</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">App</span> (<span class="keyword">val</span> id: String, <span class="keyword">val</span> name: String, <span class="keyword">val</span> version: String)</span><br></pre></td></tr></table></figure>

<p>接下来，我们可以根据服务器接口的功能进行归类，创建不同种类的接口文件，并在其中定义对应具体服务器接口的方法。不过由于我们的<strong>Apache</strong>服务器上其实只有一个获取<strong>JSON</strong>数据的接口，因此这里只需要定义一个接口文件，并包含一个方法即可。新建<code>AppService</code>接口，代码如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.retrofittest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> retrofit2.Call</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.GET</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Author: Charlie_Liao</span></span><br><span class="line"><span class="comment"> * Time: 2024/2/19-15:26</span></span><br><span class="line"><span class="comment"> * E-mail: rookie_l@icu007.work</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">AppService</span> &#123;</span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getAppData</span><span class="params">()</span></span>: Call&lt;List&lt;App&gt;&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常<code>Retrofit</code>的接口文件建议以具体的功能种类名开头，并以<code>Service</code>结尾，这是一种比较好的命名习惯。</p>
<p>上述代码中有两点需要我们注意。第一就是在<code>getAppData()</code>方法上面添加的注解，这里使用了一个<code>@GET</code>注解，<strong>表示当调用<code>getAppData()</code>方法时<code>Retrofit</code>会发起一条GET请求，请求的地址就是我们在<code>@GET</code>注解中传入的具体参数。</strong>注意，<strong>这里只需要传入请求地址的相对路径即可</strong>，根路径我们会在稍后设置。</p>
<p>第二就是<code>getAppData()</code>方法的返回值必须声明成<code>Retrofit</code>中内置的<strong>Call</strong>类型，并通过泛型来指定服务器响应的数据应该转换成什么对象。由于服务器响应的是一个包含<strong>App</strong>数据的<strong>JSON</strong>数组，因此这里我们将泛型声明成<code>List&lt;App&gt;</code>。当然，<code>Retrofit</code>还提供了强大的<strong>Call</strong> <strong>Adapters</strong>功能来允许我们自定义方法返回值的类型，比如<code>Retrofit</code>结合<code>RxJava</code>使用就可以将返回值声明成<code>Observable</code>、<code>Flowable</code>等类型。</p>
<p>定义好了<code>AppService</code>接口之后，接下来的问题就是该如何使用它。为了方便测试，我们还得在界面上添加一个按钮才行。修改<code>activity_main.xml</code>中的代码，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/getAppDataBtn&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;Get App Data&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_margin</span>=<span class="string">&quot;10dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改<strong>MainActivity</strong>中的代码，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> work.icu007.retrofittest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> retrofit2.Call</span><br><span class="line"><span class="keyword">import</span> retrofit2.Callback</span><br><span class="line"><span class="keyword">import</span> retrofit2.Response</span><br><span class="line"><span class="keyword">import</span> retrofit2.Retrofit</span><br><span class="line"><span class="keyword">import</span> retrofit2.converter.gson.GsonConverterFactory</span><br><span class="line"><span class="keyword">import</span> work.icu007.retrofittest.databinding.ActivityMainBinding</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mainBinding: ActivityMainBinding</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        mainBinding = ActivityMainBinding.inflate(layoutInflater)</span><br><span class="line">        setContentView(mainBinding.root)</span><br><span class="line"></span><br><span class="line">        mainBinding.getAppDataBtn.setOnClickListener &#123;</span><br><span class="line">            <span class="keyword">val</span> retrofit = Retrofit.Builder()</span><br><span class="line">                .baseUrl(<span class="string">&quot;http://10.0.2.2:8088/&quot;</span>)</span><br><span class="line">                .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">                .build()</span><br><span class="line">            <span class="keyword">val</span> appService = retrofit.create(AppService::<span class="keyword">class</span>.java)</span><br><span class="line">            appService.getAppData().enqueue(<span class="keyword">object</span> : Callback&lt;List&lt;App&gt;&gt; &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onResponse</span><span class="params">(call: <span class="type">Call</span>&lt;<span class="type">List</span>&lt;<span class="type">App</span>&gt;&gt;, response: <span class="type">Response</span>&lt;<span class="type">List</span>&lt;<span class="type">App</span>&gt;&gt;)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">val</span> list = response.body()</span><br><span class="line">                    <span class="keyword">if</span> (list != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (app <span class="keyword">in</span> list) &#123;</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;onResponse: id is <span class="subst">$&#123;app.id&#125;</span>&quot;</span>)</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;onResponse: name is <span class="subst">$&#123;app.name&#125;</span>&quot;</span>)</span><br><span class="line">                            Log.d(<span class="string">&quot;MainActivity&quot;</span>, <span class="string">&quot;onResponse: version is <span class="subst">$&#123;app.version&#125;</span>&quot;</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onFailure</span><span class="params">(call: <span class="type">Call</span>&lt;<span class="type">List</span>&lt;<span class="type">App</span>&gt;&gt;, t: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">                    t.printStackTrace()</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在“Get App Data”按钮的点击事件当中，首先使用了<code>Retrofit.Builder</code>来构建一个<code>Retrofit</code>对象，<strong>其中<code>baseUrl()</code>方法用于指定所有<code>Retrofit</code>请求的根路径，<code>addConverterFactory()</code>方法用于指定<code>Retrofit</code>在解析数据时所使用的转换库，这里指定成<code>GsonConverterFactory</code>。注意这两个方法都是必须调用的。</strong></p>
<p>有了<code>Retrofit</code>对象之后，我们就可以调用它的<code>create()</code>方法，并传入具体<strong>Service</strong>接口所对应的<strong>Class</strong>类型，创建一个该接口的动态代理对象。如果不熟悉什么是动态代理也没有关系，只需要知道<strong>有了动态代理对象之后，我们就可以随意调用接口中定义的所有方法，而<code>Retrofit</code>会自动执行具体的处理</strong>就可以了。</p>
<p>对应到上述的代码当中，当调用了<code>AppService</code>的<code>getAppData()</code>方法时，会返回一个<code>Call&lt;List&lt;App&gt;&gt;</code>对象，这时我们再调用一下它的<code>enqueue()</code>方法，<code>Retrofit</code>就会根据注解中配置的服务器接口地址去进行网络请求了，服务器响应的数据会回调到<code>enqueue()</code>方法中传入的<strong>Callback</strong>实现里面。需要注意的是，当发起请求的时候，<code>Retrofit</code>会自动在内部开启子线程，当数据回调到<strong>Callback</strong>中之后，<code>Retrofit</code>又会自动切换回主线程，整个操作过程中我们都不用考虑线程切换问题。在<strong>Callback</strong>的<code>onResponse()</code>方法中，调用<code>response.body()</code>方法将会得到<code>Retrofit</code>解析后的对象，也就是<code>List&lt;App&gt;</code>类型的数据，最后遍历List，将其中的数据打印出来即可。</p>
<p>这里使用的服务器接口仍然是HTTP，因此我们还要进行网络安全配置才行。</p>
<p>新建<code>network_config.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">network-security-config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">base-config</span> <span class="attr">cleartextTrafficPermitted</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">certificates</span> <span class="attr">src</span>=<span class="string">&quot;system&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">trust-anchors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">base-config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">network-security-config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改 <code>AndroidManifest.xml</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:dataExtractionRules</span>=<span class="string">&quot;@xml/data_extraction_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:fullBackupContent</span>=<span class="string">&quot;@xml/backup_rules&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:networkSecurityConfig</span>=<span class="string">&quot;@xml/network_config&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-2-处理复杂的接口地址类型"><a href="#6-2-处理复杂的接口地址类型" class="headerlink" title="6.2 处理复杂的接口地址类型"></a>6.2 处理复杂的接口地址类型</h3><p>在上一小节中，我们通过示例程序向一个非常简单的服务器接口地址发送请求：<a target="_blank" rel="noopener" href="http://10.0.2.2/8088/get_data.json">http://10.0.2.2/8088/get_data.json</a>，然而在真实的开发环境当中，服务器所提供的接口地址不可能一直如此简单。如果你在使用浏览器上网时观察一下浏览器上的网址，你会发现这些网址可能会是千变万化的，那么本小节我们就来学习一下如何使用<code>Retrofit</code>来应对这些千变万化的情况。</p>
<p>为了方便举例，这里先定义一个Data类，并包含id和content这两个字段，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Data</span>(<span class="keyword">val</span> id: String, <span class="keyword">val</span> content: String)</span><br></pre></td></tr></table></figure>

<p>然后我们先从最简单的看起，比如服务器的接口地址如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//example.com/get_data.json</span></span><br></pre></td></tr></table></figure>

<p>这是最简单的一种情况，接口地址是静态的，永远不会改变。那么对应到<code>Retrofit</code>当中，使用如下的写法即可：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">()</span></span>: Call&lt;Data&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这也是我们在上一小节中已经学过的部分，理解起来应该非常简单吧。</p>
<p>但是显然服务器不可能总是给我们提供静态类型的接口，在很多场景下，接口地址中的部分内容可能会是动态变化的，比如如下的接口地址：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//example.com/&lt;page&gt;/get_data.json</span></span><br></pre></td></tr></table></figure>

<p>在这个接口当中，<code>&lt;page&gt;</code>部分代表页数，我们传入不同的页数，服务器返回的数据也会不同。这种接口地址对应到<code>Retrofit</code>当中应该怎么写呢？其实也很简单，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;&#123;page&#125;/get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">(<span class="meta">@Path(<span class="string">&quot;page&quot;</span>)</span> page: <span class="type">Int</span>)</span></span>: Call&lt;Data&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>@GET</code>注解指定的接口地址当中，这里使用了一个<code>&#123;page&#125;</code>的占位符，然后又在<code>getData()</code>方法中添加了一个<strong>page</strong>参数，并使用<code>@Path(&quot;page&quot;)</code>注解来声明这个参数。这样当调用<code>getData()</code>方法发起请求时，<code>Retrofit</code>就会自动将<strong>page</strong>参数的值替换到占位符的位置，从而组成一个合法的请求地址。</p>
<p>另外，很多服务器接口还会要求我们传入一系列的参数，格式如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//example.com/get_data.json?u&lt;user&gt;&amp;t=&lt;token&gt;</span></span><br></pre></td></tr></table></figure>

<p>这是一种标准的带参数<strong>GET</strong>请求的格式。<strong>接口地址的最后使用问号来连接参数部分，每个参数都是一个使用等号连接的键值对，多个参数之间使用“&amp;”符号进行分隔。</strong>那么很显然，在上述地址中，服务器要求我们传入<strong>user</strong>和<strong>token</strong>这两个参数的值。对于这种格式的服务器接口，我们可以使用刚才所学的<code>@Path</code>注解的方式来解决，但是这样会有些麻烦，<code>Retrofit</code>针对这种带参数的<strong>GET</strong>请求，专门提供了一种语法支持：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">(<span class="meta">@Query(<span class="string">&quot;u&quot;</span>)</span> user: <span class="type">String</span>, <span class="meta">@Query(<span class="string">&quot;t&quot;</span>)</span> token: <span class="type">String</span>)</span></span>: Call&lt;Data&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里在<code>getData()</code>方法中添加了<strong>user</strong>和<strong>token</strong>这两个参数，并使用<code>@Query</code>注解对它们进行声明。这样当发起网络请求的时候，<code>Retrofit</code>就会自动按照带参数<strong>GET</strong>请求的格式将这两个参数构建到请求地址当中。</p>
<p>学习了以上内容之后，现在你在一定程度上已经可以应对千变万化的服务器接口地址了。不过<strong>HTTP</strong>并不是只有<strong>GET</strong>请求这一种类型，而是有很多种，其中比较常用的有<strong>GET</strong>、<strong>POST</strong>、<strong>PUT</strong>、<strong>PATCH</strong>、<strong>DELETE</strong>这几种。它们之间的分工也很明确，简单概括的话，<strong>GET</strong>请求用于从服务器获取数据，<strong>POST</strong>请求用于向服务器提交数据，<strong>PUT</strong>和<strong>PATCH</strong>请求用于修改服务器上的数据，<strong>DELETE</strong>请求用于删除服务器上的数据。</p>
<p>而<code>Retrofit</code>对所有常用的<strong>HTTP</strong>请求类型都进行了支持，使用<code>@GET</code>、<code>@POST</code>、<code>@PUT</code>、<code>@PATCH</code>、<code>@DELETE</code>注解，就可以让<code>Retrofit</code>发出相应类型的请求了。</p>
<p>比如服务器提供了如下接口地址：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE http:<span class="comment">//example.com/data/&lt;id&gt;</span></span><br></pre></td></tr></table></figure>

<p>这种接口通常意味着要根据id删除一条指定的数据，而我们在<code>Retrofit</code>当中想要发出这种请求就可以这样写：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@DELETE(<span class="string">&quot;data/&#123;id&#125;&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">deleteData</span><span class="params">(<span class="meta">@Path(<span class="string">&quot;id&quot;</span>)</span> id: <span class="type">String</span>)</span></span>: Call&lt;ResponseBody&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用了<code>@DELETE</code>注解来发出<strong>DELETE</strong>类型的请求，并使用了<code>@Path</code>注解来动态指定<strong>id</strong>，这些都很好理解。但是在返回值声明的时候，我们将<strong>Call</strong>的泛型指定成了<strong>ResponseBody</strong>，这是什么意思呢？</p>
<p>由于<strong>POST</strong>、<strong>PUT</strong> 、<strong>PATCH</strong>、<strong>DELETE</strong>这几种请求类型与<strong>GET</strong>请求不同，它们更多是用于操作服务器上的数据，而不是获取服务器上的数据，所以通常它们对于服务器响应的数据并不关心。这个时候就可以使用<strong>ResponseBody</strong>，表示<strong>Retrofit</strong>能够接收任意类型的响应数据，并且不会对响应数据进行解析。</p>
<p>那么如果我们需要向服务器提交数据该怎么写呢？比如如下的接口地址：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST http:<span class="comment">//example.com/data/create</span></span><br><span class="line">&#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;The description for this data.&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>使用<strong>POST</strong>请求来提交数据，需要将数据放到<strong>HTTP</strong>请求的<strong>body</strong>部分，这个功能在<code>Retrofit</code>中可以借助<code>@Body</code>注解来完成：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@POST(<span class="string">&quot;data/create&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">createData</span><span class="params">(<span class="meta">@Body</span> <span class="keyword">data</span>: <span class="type">Data</span>)</span></span>: Call&lt;ResponseBody&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里我们在<code>createData()</code>方法中声明了一个<strong>Data</strong>类型的参数，并给它加上了<code>@Body</code>注解。这样当<code>Retrofit</code>发出<strong>POST</strong>请求时，就会自动将<strong>Data</strong>对象中的数据转换成JSON格式的文本，并放到<strong>HTTP</strong>请求的<strong>body</strong>部分，服务器在收到请求之后只需要从<strong>body</strong>中将这部分数据解析出来即可。这种写法同样也可以用来给<strong>PUT</strong>、<strong>PATCH</strong>、<strong>DELETE</strong>类型的请求提交数据。</p>
<p>最后，有些服务器接口还可能会要求我们在<strong>HTTP</strong>请求的<strong>header</strong>中指定参数，比如：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET http:<span class="comment">//example.com/get_data.json</span></span><br><span class="line">User-Agent: okhttp</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>这些<strong>header</strong>参数其实就是一个个的键值对，我们可以在<code>Retrofit</code>中直接使用<code>@Headers</code>注解来对它们进行声明。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@Header(<span class="string">&quot;User-Agent: okhttp&quot;</span>, <span class="string">&quot;Cache-Control: max-age=0&quot;</span>)</span></span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">()</span></span>: Call&lt;Data&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这种写法只能进行静态<strong>header</strong>声明，如果想要动态指定<strong>header</strong>的值，则需要使用<code>@Header</code>注解，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ExampleService</span> &#123;</span><br><span class="line">    <span class="meta">@GET(<span class="string">&quot;get_data.json&quot;</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">(<span class="meta">@Header(<span class="string">&quot;User-Agent&quot;</span>)</span> userAgent: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Header(<span class="string">&quot;Cache-Control&quot;</span>)</span> cacheControl: <span class="type">String</span>)</span></span>: Call &lt;Data&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在当发起网络请求的时候，<code>Retrofit</code>就会自动将参数中传入的值设置到<code>User-Agent</code>和<code>Cache-Control</code>这两个<strong>header</strong>当中，从而实现了动态指定<strong>header</strong>值的功能。</p>
<h3 id="6-3-Retrofit构建器的最佳写法"><a href="#6-3-Retrofit构建器的最佳写法" class="headerlink" title="6.3 Retrofit构建器的最佳写法"></a>6.3 Retrofit构建器的最佳写法</h3><p>学到这里，其实还有一个问题我们没有正视过，就是获取Service接口的动态代理对象实在是太麻烦了。先回顾一下之前的写法吧，大致代码如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> retrofit = Retrofit.Builder()</span><br><span class="line">	.baseUrl(<span class="string">&quot;http:10.0.2.2/8088/&quot;</span>)</span><br><span class="line">	.addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">	.build()</span><br><span class="line"><span class="keyword">val</span> appService = retrofit.create(AppService::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>

<p>我们想要得到<code>AppService</code>的动态代理对象，需要先使用<code>Retrofit.Builder</code>构建出一个<code>Retrofit</code>对象，然后再调用<code>Retrofit</code>对象的<code>create()</code>方法创建动态代理对象。如果只是写一次还好，每次调用任何服务器接口时都要这样写一遍的话，肯定没有人能受得了。</p>
<p>事实上，确实也没有每次都写一遍的必要，因为构建出的<code>Retrofit</code>对象是全局通用的，<strong>只需要在调用<code>create()</code>方法时针对不同的Service接口传入相应的Class类型即可。</strong>因此，我们可以将通用的这部分功能封装起来，从而简化获取<strong>Service</strong>接口动态代理对象的过程。</p>
<p>新建一个<code>ServiceCreator</code>单例类，代码如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ServiceCreator &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> BASE_URL = <span class="string">&quot;http://10.0.2.2/8088&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> retrofit = Retrofit.Builder()</span><br><span class="line">    	.baseUrl(BASE_URL)</span><br><span class="line">		.addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">		.build()</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">create</span><span class="params">(serviceClass: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: T = retrofit.create(serviceClass)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们使用object关键字让<code>ServiceCreator</code>成为了一个单例类，并在它的内部定义了一个<code>BASE_URL</code>常量，用于指定<code>Retrofit</code>的根路径。然后同样是在内部使用<code>Retrofit.Builder</code>构建一个<code>Retrofit</code>对象，注意这些都是用<strong>private</strong>修饰符来声明的，相当于对于外部而言它们都是不可见的。</p>
<p>最后，我们提供了一个外部可见的<code>create()</code>方法，并接收一个<strong>Class</strong>类型的参数。当在外部调用这个方法时，实际上就是调用了<code>Retrofit</code>对象的<code>create()</code>方法，从而创建出相应<strong>Service</strong>接口的动态代理对象。</p>
<p>经过这样的封装之后，<code>Retrofit</code>的用法将会变得异常简单，比如我们想获取一个<code>AppService</code>接口的动态代理对象，只需要使用如下写法即可：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> appService = ServiceCreator.create(AppService::<span class="keyword">class</span>.java)</span><br></pre></td></tr></table></figure>

<p>之后就可以随意调用<code>AppService</code>接口中定义的任何方法了。</p>
<p>上述代码通过之前学习的学习的泛型实化功能，还可以继续优化。修改<code>ServiceCreator</code>中的代码，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ServiceCreator &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;<span class="keyword">reified</span> T&gt;</span> <span class="title">create</span><span class="params">()</span></span>: T = create(T::<span class="keyword">class</span>.java)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们又定义了一个不带参数的<code>create()</code>方法，并使用<strong>inline</strong>关键字来修饰方法，使用<strong>reified</strong>关键字来修饰泛型，这是泛型实化的两大前提条件。接下来就可以使用<code>T::class.java</code>这种语法了，这里调用刚才定义的带有<strong>Class</strong>参数的<code>create()</code>方法即可。</p>
<p>那么现在我们就又有了一种新的方式来获取<code>AppService</code>接口的动态代理对象，如下所示：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> appService = ServiceCreator.create&lt;AppService&gt;()</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://icu007.work/wp-content/uploads/2022/03/head-1.jpeg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://icu007.work/wp-content/uploads/2022/03/head-1.jpeg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Rookie_l</div><div class="post-copyright__author_desc">偷得浮生半日闲</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://icu007work.github.io/archives/4a483fcb.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://icu007work.github.io/archives/4a483fcb.html')">Kotlin安卓开发-使用网络技术</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://icu007work.github.io/archives/4a483fcb.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=Kotlin安卓开发-使用网络技术&amp;url=https://icu007work.github.io/archives/4a483fcb.html&amp;pic=https://pic2.ziyuan.wang/user/xiheya/2024/05/Network_0d14f49c4bca7.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://icu007work.github.io" target="_blank">米奇妙妙屋</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Kotlin/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Kotlin<span class="tagsPageCount">13</span></a><a class="post-meta__box__tags" href="/tags/%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>编程入门<span class="tagsPageCount">13</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://pic2.ziyuan.wang/user/xiheya/2024/05/Kotlin-Advance_535ea90c69f3c.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/archives/a3762f06.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Material_c668a539b4551.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Kotlin安卓开发-Material</div></div></a></div><div class="next-post pull-right"><a href="/archives/4fa27f9d.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Kotlin-Advance_535ea90c69f3c.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kotlin 进阶</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/archives/f2287651.html" title="Kotlin安卓开发-Broadcast"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Android-Broadcast_e002cd5cd46cc.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-28</div><div class="title">Kotlin安卓开发-Broadcast</div></div></a></div><div><a href="/archives/add4ecd9.html" title="Kotlin入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic.ziyuan.wang/2023/09/11/guest_566671d879c50.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-09-11</div><div class="title">Kotlin入门</div></div></a></div><div><a href="/archives/149564e1.html" title="Kotlin安卓开发-ContentProvider"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/ContentProvider_ade10dd50ff3c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-12-09</div><div class="title">Kotlin安卓开发-ContentProvider</div></div></a></div><div><a href="/archives/4fa27f9d.html" title="Kotlin 进阶"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Kotlin-Advance_535ea90c69f3c.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-05-11</div><div class="title">Kotlin 进阶</div></div></a></div><div><a href="/archives/14654f7f.html" title="Kotlin安卓开发-Fragment"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Android-Fragment_459fb5ae97b91.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2023-11-15</div><div class="title">Kotlin安卓开发-Fragment</div></div></a></div><div><a href="/archives/f8eec5a0.html" title="Kotlin安卓开发-Jetpack"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Jetpack_cb169f472cca5.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-01-24</div><div class="title">Kotlin安卓开发-Jetpack</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://icu007.work/wp-content/uploads/2022/03/head-1.jpeg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://bu.dusays.com/2023/08/24/64e6ce9c507bb.png" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">本站有关于<b style="color:#fff">科技、生活</b>相关的文章和随笔，还有<b style="color:#fff">编程基础知识</b>和<b style="color:#fff">实用工具</b>分享。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">希望你可以在本站中收获对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Rookie_l</h1><div class="author-info__desc">偷得浮生半日闲</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/hiheya" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/55406380" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://pic.ziyuan.wang/2023/08/22/30087e712d9fd.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://pic.ziyuan.wang/2023/08/22/e91ab86cccd2c.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81WebView%E7%9A%84%E7%94%A8%E6%B3%95"><span class="toc-text">一、WebView的用法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E4%BD%BF%E7%94%A8HTTP%E8%AE%BF%E9%97%AE%E7%BD%91%E7%BB%9C"><span class="toc-text">二、使用HTTP访问网络</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BD%BF%E7%94%A8HttpURLConnection"><span class="toc-text">2.1 使用HttpURLConnection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E4%BD%BF%E7%94%A8OkHttp"><span class="toc-text">2.2 使用OkHttp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E8%A7%A3%E6%9E%90XML%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE"><span class="toc-text">三、解析XML格式数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-0-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C-%E4%BD%BF%E7%94%A8Apache%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">3.0 准备工作(使用Apache服务器)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Pull%E8%A7%A3%E6%9E%90%E6%96%B9%E5%BC%8F"><span class="toc-text">3.1 Pull解析方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-SAX%E8%A7%A3%E6%9E%90%E6%96%B9%E5%BC%8F"><span class="toc-text">3.2 SAX解析方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E8%A7%A3%E6%9E%90JSON%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE"><span class="toc-text">四、解析JSON格式数据</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E4%BD%BF%E7%94%A8JSONObject"><span class="toc-text">4.1 使用JSONObject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E4%BD%BF%E7%94%A8GSON"><span class="toc-text">4.2 使用GSON</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%E5%9B%9E%E8%B0%83%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">五、网络请求回调的实现方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%9C%80%E5%A5%BD%E7%94%A8%E7%9A%84%E7%BD%91%E7%BB%9C%E5%BA%93%EF%BC%9A-Retrofit"><span class="toc-text">六、最好用的网络库： Retrofit</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Retrofit%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">6.1 Retrofit的基本用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%A4%84%E7%90%86%E5%A4%8D%E6%9D%82%E7%9A%84%E6%8E%A5%E5%8F%A3%E5%9C%B0%E5%9D%80%E7%B1%BB%E5%9E%8B"><span class="toc-text">6.2 处理复杂的接口地址类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-Retrofit%E6%9E%84%E5%BB%BA%E5%99%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E5%86%99%E6%B3%95"><span class="toc-text">6.3 Retrofit构建器的最佳写法</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/4fa27f9d.html" title="Kotlin 进阶"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Kotlin-Advance_535ea90c69f3c.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kotlin 进阶"/></a><div class="content"><a class="title" href="/archives/4fa27f9d.html" title="Kotlin 进阶">Kotlin 进阶</a><time datetime="2024-05-11T07:40:52.000Z" title="发表于 2024-05-11 15:40:52">2024-05-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/4a483fcb.html" title="Kotlin安卓开发-使用网络技术"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Network_0d14f49c4bca7.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kotlin安卓开发-使用网络技术"/></a><div class="content"><a class="title" href="/archives/4a483fcb.html" title="Kotlin安卓开发-使用网络技术">Kotlin安卓开发-使用网络技术</a><time datetime="2024-03-13T07:37:24.000Z" title="发表于 2024-03-13 15:37:24">2024-03-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/a3762f06.html" title="Kotlin安卓开发-Material"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Material_c668a539b4551.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kotlin安卓开发-Material"/></a><div class="content"><a class="title" href="/archives/a3762f06.html" title="Kotlin安卓开发-Material">Kotlin安卓开发-Material</a><time datetime="2024-02-27T07:34:17.000Z" title="发表于 2024-02-27 15:34:17">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/6c099795.html" title="Kotlin安卓开发-高级技巧"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Advance_7270c77bc7e69.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kotlin安卓开发-高级技巧"/></a><div class="content"><a class="title" href="/archives/6c099795.html" title="Kotlin安卓开发-高级技巧">Kotlin安卓开发-高级技巧</a><time datetime="2024-02-04T07:31:01.000Z" title="发表于 2024-02-04 15:31:01">2024-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/f8eec5a0.html" title="Kotlin安卓开发-Jetpack"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic2.ziyuan.wang/user/xiheya/2024/05/Jetpack_cb169f472cca5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Kotlin安卓开发-Jetpack"/></a><div class="content"><a class="title" href="/archives/f8eec5a0.html" title="Kotlin安卓开发-Jetpack">Kotlin安卓开发-Jetpack</a><time datetime="2024-01-24T07:28:13.000Z" title="发表于 2024-01-24 15:28:13">2024-01-24</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:rookie_l@icu007.work" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/5400016811" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=61550101473898&amp;mibextid=2JQ9oc" title="facebook"><i class="anzhiyufont anzhiyu-icon-facebook1"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://icu007.work/wp-content/uploads/2022/03/head-1.jpeg" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/hiheya" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/55406380" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://v.douyin.com/iJm1hSu7/" title="抖音"><i class="anzhiyufont anzhiyu-icon-tiktok"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral/" title="本网站由 又拍云 提供CDN加速/云存储服务"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-upyun"></use></svg></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a><a class="footer-item" title="本网站由 又拍云 提供CDN加速/云存储服务" target="_blank" rel="noopener" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral/">本网站由 又拍云 提供CDN加速/云存储服务</a></div></div><div class="footer-group"><div class="footer-title">关于</div><div class="footer-links"><a class="footer-item" title="关于作者" href="/about/">关于作者</a><a class="footer-item" title="文章归档" href="/archives/">文章归档</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="友链文章" href="/fcircle/">友链文章</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title">协议</div><div class="footer-links"><a class="footer-item" title="隐私协议" href="/privacy/">隐私协议</a><a class="footer-item" title="Cookies" href="/cookies/">Cookies</a><a class="footer-item" title="版权协议" href="/copyright/">版权协议</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&amp;utm_medium=referral/" style="margin-inline:5px" data-title="本站使用又拍云为静态资源提供CDN加速" title="本站使用又拍云为静态资源提供CDN加速"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.shields.io/badge/CDN-又拍云-blue.svg?logo=iCloud" alt="本站使用又拍云为静态资源提供CDN加速"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2020 - 2024 By <a class="footer-bar-link" href="/" title="Rookie_l" target="_blank">Rookie_l</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = ["尊重所有声音&#44; 但成为自己."]
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://icu007.work" title="主站">主站</a><a class="footer-bar-link cc" href="/copyright" title="cc协议"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-by-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nc-line"></i><i class="anzhiyufont anzhiyu-icon-creative-commons-nd-line"></i></a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">4</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://icu007.work/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://chat.icu007.work/" title="ChatGPT"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="ChatGPT"/><span class="back-menu-item-text">ChatGPT</span></a><a class="back-menu-item" target="_blank" rel="noopener" href="https://baidu.icu007.work/" title="帮你百度一下"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="帮你百度一下"/><span class="back-menu-item-text">帮你百度一下</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 站务</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/air-conditioner/"><i class="anzhiyufont anzhiyu-icon-fan faa-tada" style="font-size: 0.9em;"></i><span> 空调</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友链</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=6842714056&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 番剧</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于我</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 碎碎念</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 传送门</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Android/" style="font-size: 0.88rem;">Android<sup>2</sup></a><a href="/tags/Dos/" style="font-size: 0.88rem;">Dos<sup>1</sup></a><a href="/tags/IDEA/" style="font-size: 0.88rem;">IDEA<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>23</sup></a><a href="/tags/Java%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" style="font-size: 0.88rem;">Java基础语法<sup>5</sup></a><a href="/tags/Java%E5%BC%82%E5%B8%B8/" style="font-size: 0.88rem;">Java异常<sup>2</sup></a><a href="/tags/Java%E6%95%B0%E7%BB%84/" style="font-size: 0.88rem;">Java数组<sup>3</sup></a><a href="/tags/Java%E6%96%B9%E6%B3%95/" style="font-size: 0.88rem;">Java方法<sup>1</sup></a><a href="/tags/Java%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/" style="font-size: 0.88rem;">Java流程控制<sup>3</sup></a><a href="/tags/Java%E7%89%B9%E6%80%A7/" style="font-size: 0.88rem;">Java特性<sup>1</sup></a><a href="/tags/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">Java面向对象<sup>4</sup></a><a href="/tags/Kotlin/" style="font-size: 0.88rem;">Kotlin<sup>13</sup></a><a href="/tags/Markdown/" style="font-size: 0.88rem;">Markdown<sup>1</sup></a><a href="/tags/WP/" style="font-size: 0.88rem;">WP<sup>1</sup></a><a href="/tags/git/" style="font-size: 0.88rem;">git<sup>2</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">排序算法<sup>1</sup></a><a href="/tags/%E7%A1%AC%E4%BB%B6/" style="font-size: 0.88rem;">硬件<sup>1</sup></a><a href="/tags/%E7%BC%96%E7%A8%8B%E5%85%A5%E9%97%A8/" style="font-size: 0.88rem;">编程入门<sup>13</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>2</sup></a><a href="/tags/%E8%BD%AF%E4%BB%B6%E5%88%86%E4%BA%AB/" style="font-size: 0.88rem;">软件分享<sup>1</sup></a><a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 0.88rem;">随笔<sup>13</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="6842714056" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=6842714056&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const initValine = () => {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'DSKC4Zc0A0aO83qSYyJIczkF-gzGzoHsz',
      appKey: 'X4vG5DxFgvkzTBQNF8IRA7gi',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, {"valine":"/js/myjs/Valine.min.js"}))
  }

  const loadValine = async () => {
    if (typeof Valine === 'function') initValine()
    else {
      await getScript('/js/myjs/Valine.min.js')
      initValine()
    }
  }

  if ('Valine' === 'Valine' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('vcomment'),loadValine)
    else setTimeout(loadValine, 0)
  } else {
    window.loadOtherComment = loadValine
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script src="https://cdn.cbd.int/blueimp-md5@2.19.0/js/md5.min.js"></script><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getIcon = (icon, mail) => {
    if (icon) return icon
    let defaultIcon = '?d=monsterid'
    let iconUrl = `https://gravatar.loli.net/avatar/${md5(mail.toLowerCase()) + defaultIcon}`
    return iconUrl
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'></a>`
        }

        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <div class='name'><span>${array[i].nick} / </span><time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div></div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const getComment = () => {
    const serverURL = 'https://DSKC4Zc0.api.lncldglobal.com'

    var settings = {
      "method": "GET",
      "headers": {
        "X-LC-Id": 'DSKC4Zc0A0aO83qSYyJIczkF-gzGzoHsz',
        "X-LC-Key": 'X4vG5DxFgvkzTBQNF8IRA7gi',
        "Content-Type": "application/json"
      },
    }

    fetch(`${serverURL}/1.1/classes/Comment?limit=6&order=-createdAt`,settings)
      .then(response => response.json())
      .then(data => {
        const valineArray = data.results.map(function (e) {
          return {
            'avatar': getIcon(e.QQAvatar, e.mail),
            'content': changeContent(e.comment),
            'nick': e.nick,
            'url': e.url + '#' + e.objectId,
            'date': e.updatedAt,
          }
        })
        saveToLocal.set('valine-newest-comments', JSON.stringify(valineArray), 10/(60*24))
        generateHtml(valineArray)
      }).catch(e => {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      }) 
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('valine-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script async src="https://at.alicdn.com/t/c/font_4201142_cetcbzr9wn.js"></script><script type="text/javascript" src="https://npm.elemecdn.com/jquery@latest/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>